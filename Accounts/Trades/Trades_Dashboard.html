<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>save4trade database</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #fafafa;
            padding: 20px;
            font-weight: 300;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border-radius: 12px;
            overflow: hidden;
        }

        .header {
            background: #1a1a1a;
            color: white;
            padding: 24px 32px;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 300;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .header p {
            font-size: 0.85em;
            opacity: 0.7;
            font-weight: 300;
        }

        .kofi-container {
            margin-top: 14px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .kofi-container a {
            display: inline-block;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .kofi-container a:hover {
            opacity: 1;
        }

        .kofi-container img {
            height: 37px;
            width: 185px;
            border-radius: 8px;
        }

        .language-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: -3px;
        }

        .language-selector::before {
            content: "ğŸŒ";
            font-size: 1.2em;
            opacity: 0.9;
        }

        .language-selector select {
            padding: 8px 32px 8px 12px;
            border: 1px solid #666;
            background: #2a2a2a;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 400;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"%3e%3cpolyline points="6 9 12 15 18 9"%3e%3c/polyline%3e%3c/svg%3e');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            transition: all 0.2s;
        }

        .language-selector select:hover {
            background-color: #3a3a3a;
            border-color: #888;
        }

        .language-selector select:focus {
            outline: none;
            border-color: #999;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .language-selector select option {
            padding: 8px 12px;
            background: #2a2a2a;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .stat-card {
            padding: 12px 20px;
            text-align: center;
            border-right: 1px solid #e0e0e0;
        }

        .stat-card:last-child {
            border-right: none;
        }

        .stat-card .number {
            font-size: 2em;
            font-weight: 300;
            color: #1a1a1a;
        }

        .stat-card .label {
            color: #999;
            margin-top: 4px;
            font-size: 0.75em;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        .xmlDownloadLink {
            color: #1a1a1a;
            font-size: 1.4em;
            font-weight: 400;
            text-decoration-line: none;
            cursor: pointer;
            display: inline-block;
            transition: transform 0.2s, color 0.2s;
            line-height: 1;
        }

        .xmlDownloadLink:hover {
            color: #0066cc;
            transform: scale(1.15);
        }

        .controls {
            padding: 16px 24px;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }

        .filter-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group label {
            font-weight: 400;
            color: #666;
            font-size: 0.85em;
        }

        .filter-group select,
        .filter-group input {
            padding: 6px 12px;
            border: 1px solid #ddd;
            font-size: 0.85em;
            font-family: inherit;
            font-weight: 300;
            background: white;
            border-radius: 8px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #1a1a1a;
        }

        .btn {
            background: white;
            color: #1a1a1a;
            border: 1px solid #1a1a1a;
            padding: 6px 16px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 400;
            font-family: inherit;
            transition: all 0.2s;
            border-radius: 8px;
        }

        .btn:hover {
            background: #1a1a1a;
            color: white;
        }

        .btn.active {
            background: #1a1a1a;
            color: white;
        }

        .btn:disabled,
        select:disabled,
        input:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .table-container {
            padding: 24px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th {
            background: #fafafa;
            padding: 10px 12px;
            text-align: left;
            font-weight: bold;
            color: #000000;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.8em;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        th.sortable:hover {
            background: #efefef;
        }

        th.sortable::after {
            content: " â‡…";
            opacity: 0.3;
            font-size: 0.9em;
        }

        th.sortable.sorted-asc::after {
            content: " â–²";
            opacity: 1;
            color: #1a1a1a;
        }

        th.sortable.sorted-desc::after {
            content: " â–¼";
            opacity: 1;
            color: #1a1a1a;
        }

        th.col-account {
            width: 70px;
            max-width: 70px;
        }

        th.col-time {
            width: 80px;
            max-width: 80px;
            font-size: 0.8em;
        }

        th.col-pack {
            width: 80px;
            max-width: 80px;
        }

        th.col-xml {
            width: 65px;
            max-width: 65px;
        }

        th.col-cards {
            width: 90px;
            max-width: 90px;
        }

        th.col-screenshot {
            width: 120px;
            max-width: 120px;
            font-size: 0.8em;
        }

        th.col-shinedust {
            width: 70px;
            max-width: 70px;
            font-size: 0.8em;
        }

        th.col-subTime {
            width: 80px;
            max-width: 80px;
            font-size: 0.8em;
        }

        th.col-age {
            width: 70px;
            max-width: 70px;
            font-size: 0.8em;
            text-align: center;
        }

        td.col-age {
            width: 70px;
            max-width: 70px;
            font-size: 0.85em;
            text-align: center;
            color: #666;
        }

        .expandable {
            cursor: pointer;
            transition: background 0.2s;
        }

        .expandable:hover {
            background: #f5f5f5;
        }

        .expandable.expanded {
            background: #e8f4f8;
            border-left: 3px solid #4a90e2;
        }

        .detail-row {
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
            border-left: 3px solid #4a90e2;
        }

        .detail-row.last-detail-row {
            border-bottom: 3px solid #4a90e2;
            margin-bottom: 4px;
        }

        .detail-row td {
            font-size: 0.75em;
            color: #666;
            padding: 8px 12px;
        }

        td {
            padding: 8px 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.85em;
        }

        .summary-stats {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .summary-badge {
            display: inline-block;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 0.9em;
            font-weight: 400;
            margin: 2px;
            border: 1px solid;
            border-radius: 12px;
        }

        .badge-pack {
            background: #f0f0f0;
            color: #1a1a1a;
            border-color: #ddd;
            font-size: 0.95em;
            border-radius: 12px;
        }

        .badge-card {
            background: white;
            color: #1a1a1a;
            border-color: #999;
            font-size: 0.9em;
            border-radius: 12px;
        }

        /* Card type specific colors */
        .badge-crown {
            background: #FFF8DC !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-4diamond {
            background: #E3F2FD !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-3diamond {
            background: #E8F5E9 !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-2diamond {
            background: #FFF3E0 !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-1diamond {
            background: #FFEBEE !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-rainbow {
            background: linear-gradient(90deg,
                #FFB3BA 0%,
                #FFDFBA 16.67%,
                #FFFFBA 33.33%,
                #BAFFBA 50%,
                #BAE1FF 66.67%,
                #D7BAFF 83.33%,
                #FFB3D9 100%) !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-shiny1star,
        .badge-shiny2star {
            background: linear-gradient(45deg, #B8B8B8, #D8D8D8) !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-1star,
        .badge-2star {
            background: #FFFDE7 !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-immersive {
            background: linear-gradient(135deg, #E8D5F2 0%, #D1C4E9 50%, #B39DDB 100%) !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-fullart {
            background: #C8E6C9 !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-trainer {
            background: #BBDEFB !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .card-crown {
            color: #B8860B;
            font-weight: 500;
        }

        .card-diamond {
            font-weight: 500;
        }

        .card-rainbow {
            color: #6A1B9A;
            font-weight: 600;
        }

        .card-shiny {
            color: #666;
            font-weight: 500;
        }

        .card-immersive {
            color: #4A148C;
            font-weight: 600;
        }

        .card-fullart {
            color: #6A1B9A;
            font-weight: 500;
        }

        .card-trainer {
            color: #C62828;
            font-weight: 500;
        }

        .card-star {
            color: #DAA520;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-weight: 300;
        }

        .empty-state h2 {
            margin-bottom: 8px;
            font-weight: 300;
        }

        #fileInput {
            display: none;
        }
        
        .export-btn {
            background: #1a1a1a;
            color: white;
        }

        .export-btn:hover {
            background: #333;
        }

        .device-account {
            width: 80px;
            max-width: 80px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.8em;
            color: #000000;
            font-weight: 300;
        }

        .detail-screenshot {
            width: 120px;
            max-width: 120px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.75em;
            color: #000000;
            font-weight: 300;
        }

        .time-cell {
            width: 130px;
            font-size: 0.7em;
            color: #999;
        }

        .expand-icon {
            display: inline-block;
            width: 16px;
            text-align: center;
            margin-right: 8px;
            color: #666;
            font-size: 0.9em;
        }

        .expand-icon.expanded {
            transform: rotate(0deg);
        }

        .PackScreenshot {
            max-width: 110px;
            max-height: 80px;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: transform 0.2s;
            border-radius: 8px;
        }

        .PackScreenshot:hover {
            transform: scale(1.05);
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            max-width: 90%;
            max-height: 90%;
            text-align: center;
        }

        .popup-content img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .close-btn {
            display: block;
            margin: 20px auto 0;
            padding: 10px 30px;
            background: white;
            color: #1a1a1a;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.2s;
            border-radius: 8px;
        }

        .close-btn:hover {
            background: #f0f0f0;
        }

        .shinedust-high {
            color: #00cc00;
            font-weight: 500;
        }

        .shinedust-low {
            color: #cc0000;
            font-weight: 500;
        }

        .col-xml {
            font-size: 0.7em;
        }

    </style>
    <script>
        // Translation dictionary
        const translations = {
            en: {
                uniqueAccounts: "unique accounts",
                totalCards: "total cards",
                loadCSV: "load csv",
                allPacks: "all packs",
                allCards: "all cards",
                searchPlaceholder: "search account...",
                exportBtn: "export",
                deviceAccount: "deviceAccount",
                pack: "pack",
                cards: "cards",
                xml: ".xml",
                shinedust: "shinedust",
                screenshot: "screenshot",
                date: "date",
                ageDays: "age (days)",
                noData: "no data loaded",
                clickLoad: "click load csv to view database",
                noResults: "no results",
                tryFilters: "try different filters",
                // Pack names
                megagyarados: "Mega Gyarados",
                megablaziken: "Mega Blaziken",
                megaaltaria: "Mega Altaria",
                deluxe: "Deluxe",
                springs: "Springs",
                hooh: "Ho-Oh",
                lugia: "Lugia",
                eevee: "Eevee",
                buzzwole: "Extradimensional Crisis",
                solgaleo: "Solgaleo",
                lunala: "Lunala",
                shining: "Shining",
                arceus: "Arceus",
                palkia: "Palkia",
                dialga: "Dialga",
                pikachu: "Pikachu",
                charizard: "Charizard",
                mewtwo: "Mewtwo",
                mew: "Mew",
                // Card types
                crown: "Crown",
                fullart: "Full Art",
                trainer: "Trainer",
                rainbow: "Rainbow",
                shiny1star: "Shiny",
                shiny2star: "Shiny",
                "1star": "1 Star",
                "2star": "2 Star",
                immersive: "Immersive",
                "4diamond": "â—†â—†â—†â—†",
                "3diamond": "â—†â—†â—†",
                "2diamond": "â—†â—†",
                "1diamond": "â—†"
            },
            zh: {
                uniqueAccounts: "ç‹¬ç‰¹å¸æˆ·",
                totalCards: "æ€»å¡æ•°",
                loadCSV: "åŠ è½½ csv",
                allPacks: "æ‰€æœ‰å¡åŒ…",
                allCards: "æ‰€æœ‰å¡ç‰Œ",
                searchPlaceholder: "æœç´¢å¸æˆ·...",
                exportBtn: "å¯¼å‡º",
                deviceAccount: "è®¾å¤‡å¸æˆ·",
                pack: "å¡åŒ…",
                cards: "å¡ç‰Œ",
                xml: ".xml",
                shinedust: "é—ªå…‰å°˜",
                screenshot: "æˆªå›¾",
                date: "æ—¥æœŸ",
                ageDays: "å¤©æ•°",
                noData: "æœªåŠ è½½æ•°æ®",
                clickLoad: "ç‚¹å‡»åŠ è½½ csv æŸ¥çœ‹æ•°æ®åº“",
                noResults: "æ— ç»“æœ",
                tryFilters: "å°è¯•ä¸åŒçš„ç­›é€‰å™¨",
                // Pack names
                megagyarados: "è¶…ç´šæš´é¯‰é¾",
                megablaziken: "è¶…ç´šç«ç„°é›",
                megaaltaria: "è¶…ç´šä¸ƒå¤•é’é³¥",
                deluxe: "è±ªè¯",
                springs: "æº«æ³‰",
                hooh: "é³³ç‹",
                lugia: "æ´›å¥‡äº",
                eevee: "ä¼Šå¸ƒ",
                buzzwole: "ç•°æ¬¡å…ƒå±æ©Ÿ",
                solgaleo: "ç´¢çˆ¾è¿¦é›·æ­",
                lunala: "éœ²å¥ˆé›…æ‹‰",
                shining: "é–ƒè€€",
                arceus: "é˜¿çˆ¾å®™æ–¯",
                palkia: "å¸•è·¯å¥‡äº",
                dialga: "å¸ç‰™ç›§å¡",
                pikachu: "çš®å¡ä¸˜",
                charizard: "å™´ç«é¾",
                mewtwo: "è¶…å¤¢",
                mew: "å¤¢å¹»",
                // Card types
                crown: "ç‹å† ",
                fullart: "å…¨æ¯",
                trainer: "è®­ç»ƒå®¶",
                rainbow: "å½©è™¹",
                shiny1star: "é—ªå¡",
                shiny2star: "é—ªå¡",
                "1star": "1æ˜Ÿ",
                "2star": "2æ˜Ÿ",
                immersive: "æ²‰æµ¸å¼",
                "4diamond": "â—†â—†â—†â—†",
                "3diamond": "â—†â—†â—†",
                "2diamond": "â—†â—†",
                "1diamond": "â—†"
            },
            ja: {
                uniqueAccounts: "å›ºæœ‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ",
                totalCards: "åˆè¨ˆã‚«ãƒ¼ãƒ‰æ•°",
                loadCSV: "csvèª­ã¿è¾¼ã¿",
                allPacks: "ã™ã¹ã¦ã®ãƒ‘ãƒƒã‚¯",
                allCards: "ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰",
                searchPlaceholder: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¤œç´¢...",
                exportBtn: "ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
                deviceAccount: "ãƒ‡ãƒã‚¤ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ",
                pack: "ãƒ‘ãƒƒã‚¯",
                cards: "ã‚«ãƒ¼ãƒ‰",
                xml: ".xml",
                shinedust: "ã‚·ãƒ£ã‚¤ãƒ³ãƒ€ã‚¹ãƒˆ",
                screenshot: "ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ",
                date: "æ—¥ä»˜",
                ageDays: "æ—¥æ•°",
                noData: "ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“",
                clickLoad: "csvã‚’èª­ã¿è¾¼ã‚“ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’è¡¨ç¤º",
                noResults: "çµæœãªã—",
                tryFilters: "åˆ¥ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è©¦ã™",
                // Pack names
                megagyarados: "ãƒ¡ã‚¬ã‚®ãƒ£ãƒ©ãƒ‰ã‚¹",
                megablaziken: "ãƒ¡ã‚¬ãƒã‚·ãƒ£ãƒ¼ãƒ¢",
                megaaltaria: "ãƒ¡ã‚¬ãƒãƒ«ã‚¿ãƒªã‚¹",
                deluxe: "ãƒ‡ãƒ©ãƒƒã‚¯ã‚¹",
                springs: "æ¸©æ³‰",
                hooh: "ãƒ›ã‚¦ã‚ªã‚¦",
                lugia: "ãƒ«ã‚®ã‚¢",
                eevee: "ã‚¤ãƒ¼ãƒ–ã‚¤",
                buzzwole: "ç•°æ¬¡å…ƒã®å±æ©Ÿ",
                solgaleo: "ã‚½ãƒ«ã‚¬ãƒ¬ã‚ª",
                lunala: "ãƒ«ãƒŠã‚¢ãƒ¼ãƒ©",
                shining: "ã‚·ãƒ£ã‚¤ãƒ‹ãƒ³ã‚°",
                arceus: "ã‚¢ãƒ«ã‚»ã‚¦ã‚¹",
                palkia: "ãƒ‘ãƒ«ã‚­ã‚¢",
                dialga: "ãƒ‡ã‚£ã‚¢ãƒ«ã‚¬",
                pikachu: "ãƒ”ã‚«ãƒãƒ¥ã‚¦",
                charizard: "ãƒªã‚¶ãƒ¼ãƒ‰ãƒ³",
                mewtwo: "ãƒŸãƒ¥ã‚¦ãƒ„ãƒ¼",
                mew: "ãƒŸãƒ¥ã‚¦",
                // Card types
                crown: "ã‚¯ãƒ©ã‚¦ãƒ³",
                fullart: "ãƒ•ãƒ«ã‚¢ãƒ¼ãƒˆ",
                trainer: "ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼",
                rainbow: "ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼",
                shiny1star: "ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼",
                shiny2star: "ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼",
                "1star": "1ã¤æ˜Ÿ",
                "2star": "2ã¤æ˜Ÿ",
                immersive: "ã‚¤ãƒãƒ¼ã‚·ãƒ–",
                "4diamond": "â—†â—†â—†â—†",
                "3diamond": "â—†â—†â—†",
                "2diamond": "â—†â—†",
                "1diamond": "â—†"
            },
            de: {
                uniqueAccounts: "eindeutige Konten",
                totalCards: "Gesamtkarten",
                loadCSV: "csv laden",
                allPacks: "alle Packs",
                allCards: "alle Karten",
                searchPlaceholder: "Konto suchen...",
                exportBtn: "exportieren",
                deviceAccount: "GerÃ¤tekonto",
                pack: "Pack",
                cards: "Karten",
                xml: ".xml",
                shinedust: "Glitzerstaub",
                screenshot: "Screenshot",
                date: "Datum",
                ageDays: "Alter (Tage)",
                noData: "keine Daten geladen",
                clickLoad: "csv laden, um Datenbank anzuzeigen",
                noResults: "keine Ergebnisse",
                tryFilters: "andere Filter versuchen",
                // Pack names
                megagyarados: "Mega-Garados",
                megablaziken: "Mega-Lohgock",
                megaaltaria: "Mega-Altaria",
                deluxe: "Deluxe",
                springs: "Quellen",
                hooh: "Ho-Oh",
                lugia: "Lugia",
                eevee: "Evoli",
                buzzwole: "Interdimensionale Krise",
                solgaleo: "Solgaleo",
                lunala: "Lunala",
                shining: "GlÃ¤nzend",
                arceus: "Arceus",
                palkia: "Palkia",
                dialga: "Dialga",
                pikachu: "Pikachu",
                charizard: "Glurak",
                mewtwo: "Mewtu",
                mew: "Mew",
                // Card types
                crown: "Krone",
                fullart: "Vollkunst",
                trainer: "Trainer",
                rainbow: "Regenbogen",
                shiny1star: "GlÃ¤nzend",
                shiny2star: "GlÃ¤nzend",
                "1star": "1 Stern",
                "2star": "2 Sterne",
                immersive: "Immersiv",
                "4diamond": "â—†â—†â—†â—†",
                "3diamond": "â—†â—†â—†",
                "2diamond": "â—†â—†",
                "1diamond": "â—†"
            },
            fr: {
                uniqueAccounts: "comptes uniques",
                totalCards: "total de cartes",
                loadCSV: "charger csv",
                allPacks: "tous les paquets",
                allCards: "toutes les cartes",
                searchPlaceholder: "rechercher un compte...",
                exportBtn: "exporter",
                deviceAccount: "compte appareil",
                pack: "paquet",
                cards: "cartes",
                xml: ".xml",
                shinedust: "poussiÃ¨re brillante",
                screenshot: "capture d'Ã©cran",
                date: "date",
                ageDays: "Ã¢ge (jours)",
                noData: "aucune donnÃ©e chargÃ©e",
                clickLoad: "cliquez sur charger csv pour voir la base de donnÃ©es",
                noResults: "aucun rÃ©sultat",
                tryFilters: "essayez diffÃ©rents filtres",
                // Pack names
                megagyarados: "MÃ©ga-LÃ©viator",
                megablaziken: "MÃ©ga-BrasÃ©gali",
                megaaltaria: "MÃ©ga-Altaria",
                deluxe: "Deluxe",
                springs: "Sources",
                hooh: "Ho-Oh",
                lugia: "Lugia",
                eevee: "Ã‰voli",
                buzzwole: "Crise Extradimensionnelle",
                solgaleo: "Solgaleo",
                lunala: "Lunala",
                shining: "Brillant",
                arceus: "Arceus",
                palkia: "Palkia",
                dialga: "Dialga",
                pikachu: "Pikachu",
                charizard: "Dracaufeu",
                mewtwo: "Mewtwo",
                mew: "Mew",
                // Card types
                crown: "Couronne",
                fullart: "Art Complet",
                trainer: "Dresseur",
                rainbow: "Arc-en-ciel",
                shiny1star: "Brillant",
                shiny2star: "Brillant",
                "1star": "1 Ã‰toile",
                "2star": "2 Ã‰toiles",
                immersive: "Immersif",
                "4diamond": "â—†â—†â—†â—†",
                "3diamond": "â—†â—†â—†",
                "2diamond": "â—†â—†",
                "1diamond": "â—†"
            },
            ko: {
                uniqueAccounts: "ê³ ìœ  ê³„ì •",
                totalCards: "ì´ ì¹´ë“œ",
                loadCSV: "csv ë¡œë“œ",
                allPacks: "ëª¨ë“  íŒ©",
                allCards: "ëª¨ë“  ì¹´ë“œ",
                searchPlaceholder: "ê³„ì • ê²€ìƒ‰...",
                exportBtn: "ë‚´ë³´ë‚´ê¸°",
                deviceAccount: "ê¸°ê¸° ê³„ì •",
                pack: "íŒ©",
                cards: "ì¹´ë“œ",
                xml: ".xml",
                shinedust: "ìƒ¤ì¸ë”ìŠ¤íŠ¸",
                screenshot: "ìŠ¤í¬ë¦°ìƒ·",
                date: "ë‚ ì§œ",
                ageDays: "ë‚˜ì´ (ì¼)",
                noData: "ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ",
                clickLoad: "ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë³´ë ¤ë©´ csv ë¡œë“œë¥¼ í´ë¦­í•˜ì„¸ìš”",
                noResults: "ê²°ê³¼ ì—†ìŒ",
                tryFilters: "ë‹¤ë¥¸ í•„í„°ë¥¼ ì‹œë„í•˜ì„¸ìš”",
                // Pack names
                megagyarados: "ë©”ê°€ê°¸ë¼ë„ìŠ¤",
                megablaziken: "ë©”ê°€ë²ˆì¹˜ì½”",
                megaaltaria: "ë©”ê°€íŒŒë¹„ì½”ë¦¬",
                deluxe: "ë””ëŸ­ìŠ¤",
                springs: "ì˜¨ì²œ",
                hooh: "ì¹ ìƒ‰ì¡°",
                lugia: "ë£¨ê¸°ì•„",
                eevee: "ì´ë¸Œì´",
                buzzwole: "ì´ì°¨ì› ìœ„ê¸°",
                solgaleo: "ì†”ê°€ë ˆì˜¤",
                lunala: "ë£¨ë‚˜ì•„ë¼",
                shining: "ìƒ¤ì´ë‹",
                arceus: "ì•„ë¥´ì„¸ìš°ìŠ¤",
                palkia: "í„ê¸°ì•„",
                dialga: "ë””ì•„ë£¨ê°€",
                pikachu: "í”¼ì¹´ì¸„",
                charizard: "ë¦¬ìëª½",
                mewtwo: "ë®¤ì¸ ",
                mew: "ë®¤",
                // Card types
                crown: "í¬ë¼ìš´",
                fullart: "í’€ì•„íŠ¸",
                trainer: "íŠ¸ë ˆì´ë„ˆ",
                rainbow: "ë ˆì¸ë³´ìš°",
                shiny1star: "ìƒ¤ì´ë‹ˆ",
                shiny2star: "ìƒ¤ì´ë‹ˆ",
                "1star": "1ìŠ¤íƒ€",
                "2star": "2ìŠ¤íƒ€",
                immersive: "ì´ë¨¸ì‹œë¸Œ",
                "4diamond": "â—†â—†â—†â—†",
                "3diamond": "â—†â—†â—†",
                "2diamond": "â—†â—†",
                "1diamond": "â—†"
            },
            es: {
                uniqueAccounts: "cuentas Ãºnicas",
                totalCards: "total de cartas",
                loadCSV: "cargar csv",
                allPacks: "todos los sobres",
                allCards: "todas las cartas",
                searchPlaceholder: "buscar cuenta...",
                exportBtn: "exportar",
                deviceAccount: "cuenta dispositivo",
                pack: "sobre",
                cards: "cartas",
                xml: ".xml",
                shinedust: "polvo brillante",
                screenshot: "captura de pantalla",
                date: "fecha",
                ageDays: "edad (dÃ­as)",
                noData: "no hay datos cargados",
                clickLoad: "haga clic en cargar csv para ver la base de datos",
                noResults: "sin resultados",
                tryFilters: "pruebe diferentes filtros",
                // Pack names
                megagyarados: "Mega Gyarados",
                megablaziken: "Mega Blaziken",
                megaaltaria: "Mega Altaria",
                deluxe: "Deluxe",
                springs: "Fuentes",
                hooh: "Ho-Oh",
                lugia: "Lugia",
                eevee: "Eevee",
                buzzwole: "Crisis Extradimensional",
                solgaleo: "Solgaleo",
                lunala: "Lunala",
                shining: "Brillante",
                arceus: "Arceus",
                palkia: "Palkia",
                dialga: "Dialga",
                pikachu: "Pikachu",
                charizard: "Charizard",
                mewtwo: "Mewtwo",
                mew: "Mew",
                // Card types
                crown: "Corona",
                fullart: "Arte Completo",
                trainer: "Entrenador",
                rainbow: "ArcoÃ­ris",
                shiny1star: "Brillante",
                shiny2star: "Brillante",
                "1star": "1 Estrella",
                "2star": "2 Estrellas",
                immersive: "Inmersivo",
                "4diamond": "â—†â—†â—†â—†",
                "3diamond": "â—†â—†â—†",
                "2diamond": "â—†â—†",
                "1diamond": "â—†"
            }
        };

        let currentLanguage = 'en';
        let allData = [];
        let filteredData = [];
        let expandedAccounts = new Set();
        let csvLoaded = false;
        let sortColumn = null;
        let sortDirection = 'desc'; // 'asc' or 'desc'
        let accountShinedustMap = new Map(); // Store latest shinedust for each account
        let filesUploaded = false;
        let uploadedFiles = [];

        function changeLanguage() {
            const select = document.getElementById('languageSelect');
            currentLanguage = select.value;
            
            updateUIText();
            if (csvLoaded) {
                populatePackFilter();
                updateCardFilter();
                renderTable();
            }
        }

        function updateUIText() {
            const t = translations[currentLanguage];
            
            // Update stats labels (use innerHTML to preserve icons)
            document.querySelector('#uniqueAccounts').nextElementSibling.innerHTML = '<i class="fas fa-users"></i> ' + t.uniqueAccounts;
            document.querySelector('#totalCards').nextElementSibling.innerHTML = '<i class="fas fa-layer-group"></i> ' + t.totalCards;
            
            // Update table headers
            const headerElements = document.querySelectorAll('[data-i18n]');
            headerElements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });
            
            // Update button if visible (use innerHTML to preserve icons)
            const loadBtn = document.getElementById('loadCSVBtn');
            if (loadBtn && loadBtn.style.display !== 'none') {
                loadBtn.innerHTML = '<i class="fas fa-upload"></i> ' + t.loadCSV;
            }
            
            // Update filter placeholders
            const packFilter = document.getElementById('packFilter');
            if (packFilter) {
                packFilter.options[0].textContent = t.allPacks;
            }
            
            const cardFilter = document.getElementById('cardFilter');
            if (cardFilter) {
                cardFilter.options[0].textContent = t.allCards;
            }
            
            document.getElementById('searchInput').placeholder = t.searchPlaceholder;
            // Update export button (use innerHTML to preserve icons)
            document.getElementById('exportBtn').innerHTML = '<i class="fas fa-download"></i> ' + t.exportBtn;
            
            // Update empty state if visible
            const emptyState = document.querySelector('.empty-state');
            if (emptyState) {
                const h2 = emptyState.querySelector('h2');
                const p = emptyState.querySelector('p');
                if (h2 && p) {
                    if (!csvLoaded) {
                        h2.textContent = t.noData;
                        p.textContent = t.clickLoad;
                    } else {
                        h2.textContent = t.noResults;
                        p.textContent = t.tryFilters;
                    }
                }
            }
        }

        function translatePackType(packType) {
            if (!packType) return packType;
            const t = translations[currentLanguage];
            const key = packType.toLowerCase().replace(/[^a-z0-9]/g, '');
            return t[key] || packType;
        }

        function translateCardType(cardType) {
            if (!cardType) return cardType;
            const t = translations[currentLanguage];
            const key = cardType.toLowerCase().replace(/[^a-z0-9]/g, '');
            return t[key] || cardType;
        }

        function shortenDeviceAccount(account) {
            if (!account || account.length <= 6) return account;
            return account.substring(0, 5) + '..';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const popup = document.getElementById('popup');
            const closeBtn = document.getElementById('closeBtn');

            closeBtn.addEventListener('click', () => {
                popup.style.display = 'none';
            });

            popup.addEventListener('click', e => {
                if (e.target === popup) popup.style.display = 'none';
            });

            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') popup.style.display = 'none';
            });

            document.getElementById('xmlFileInput').addEventListener('change', function(e) {
                const files = e.target.files;
                // Handle uploaded files
                uploadedFiles = Array.from(files);
                filesUploaded = true;
                alert(`Uploaded ${files.length} files. You can now download them.`);
                // Perhaps process files here
            });

            document.getElementById('fileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    parseCSV(event.target.result);
                };
                reader.readAsText(file);
            });
        });

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            
            allData = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const row = {
                    timestamp: values[0],
                    originalFilename: values[1],
                    cleanFilename: values[2],
                    deviceAccount: values[3],
                    packType: values[4],
                    cardTypes: values[5] ? values[5].split('|') : [],
                    cardCounts: values[6] ? values[6].split('|').map(Number) : [],
                    packScreenshot: values[7] ? values[7].trim() : '',
                    shinedust: values[8] ? values[8].trim() : '',
                };
                allData.push(row);
            }

            filteredData = [...allData];
            csvLoaded = true;
            sortColumn = 'date';
            sortDirection = 'desc';
            updateShinedustMap(); // Update shinedust map from all data
            enableControls();
            updateStats();
            populateFilters();
            renderTable();
        }

        function updateShinedustMap() {
            // Clear existing map
            accountShinedustMap.clear();
            
            // Group data by deviceAccount
            const accountGroups = new Map();
            allData.forEach(row => {
                if (!accountGroups.has(row.deviceAccount)) {
                    accountGroups.set(row.deviceAccount, []);
                }
                accountGroups.get(row.deviceAccount).push(row);
            });
            
            // For each account, find the latest shinedust value
            accountGroups.forEach((rows, deviceAccount) => {
                // Sort by timestamp to get the latest entry
                const sortedRows = rows.sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return dateB - dateA; // Descending order (latest first)
                });
                
                // Find the first entry with a shinedust value
                const latestShinedustEntry = sortedRows.find(row => row.shinedust && row.shinedust.trim() !== '');
                
                if (latestShinedustEntry) {
                    accountShinedustMap.set(deviceAccount, latestShinedustEntry.shinedust);
                }
            });
        }

        function enableControls() {
            document.getElementById('packFilter').disabled = false;
            document.getElementById('cardFilter').disabled = false;
            document.getElementById('searchInput').disabled = false;
            document.getElementById('exportBtn').disabled = false;
            // Hide load CSV button
            document.getElementById('loadCSVBtn').style.display = 'none';
        }

        function updateStats() {
            const uniqueAccounts = new Set(allData.map(row => row.deviceAccount)).size;
            const totalCards = allData.reduce((sum, row) => 
                sum + row.cardCounts.reduce((a, b) => a + b, 0), 0
            );

            document.getElementById('uniqueAccounts').textContent = uniqueAccounts;
            document.getElementById('totalCards').textContent = totalCards;
        }

        function populateFilters() {
            populatePackFilter();
            updateCardFilter();
            setupFilterListeners();
        }

        function populatePackFilter() {
            const packTypes = new Set(allData.map(row => row.packType));
            
            const t = translations[currentLanguage];
            const packFilter = document.getElementById('packFilter');
            const currentSelection = packFilter.value; // Preserve current selection
            
            packFilter.innerHTML = `<option value="">${t.allPacks}</option>`;
            packTypes.forEach(pack => {
                const translatedPack = translatePackType(pack);
                packFilter.innerHTML += `<option value="${pack}">${translatedPack}</option>`;
            });
            
            // Restore previous selection if it still exists
            if (currentSelection && Array.from(packFilter.options).some(opt => opt.value === currentSelection)) {
                packFilter.value = currentSelection;
            }
        }

        function setupFilterListeners() {
            const packFilter = document.getElementById('packFilter');
            const cardFilter = document.getElementById('cardFilter');
            const searchInput = document.getElementById('searchInput');
            
            // Remove existing listeners by cloning and replacing
            const newPackFilter = packFilter.cloneNode(true);
            packFilter.parentNode.replaceChild(newPackFilter, packFilter);
            
            const newCardFilter = cardFilter.cloneNode(true);
            cardFilter.parentNode.replaceChild(newCardFilter, cardFilter);
            
            const newSearchInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);
            
            // Add fresh listeners
            document.getElementById('packFilter').addEventListener('change', () => {
                updateCardFilter(); // Update card filter when pack changes
                applyFilters();
            });
            document.getElementById('cardFilter').addEventListener('change', applyFilters);
            document.getElementById('searchInput').addEventListener('input', applyFilters);
        }

        function updateCardFilter() {
            const t = translations[currentLanguage];
            const packFilter = document.getElementById('packFilter').value;
            const cardFilter = document.getElementById('cardFilter');
            const currentSelection = cardFilter.value; // Preserve current selection
            
            // Filter data based on current pack selection
            const dataToCount = packFilter 
                ? allData.filter(row => row.packType === packFilter)
                : allData;
            
            // Calculate card counts from filtered data
            const cardTypes = new Map();
            dataToCount.forEach(row => {
                row.cardTypes.forEach((type, idx) => {
                    const count = row.cardCounts[idx] || 0;
                    cardTypes.set(type, (cardTypes.get(type) || 0) + count);
                });
            });

            // Rebuild the card filter dropdown
            cardFilter.innerHTML = `<option value="">${t.allCards}</option>`;
            cardTypes.forEach((count, card) => {
                cardFilter.innerHTML += `<option value="${card}">${getCardDisplayName(card)} (${count})</option>`;
            });
            
            // Restore previous selection if it still exists
            if (currentSelection && Array.from(cardFilter.options).some(opt => opt.value === currentSelection)) {
                cardFilter.value = currentSelection;
            } else {
                cardFilter.value = ''; // Reset if previous selection no longer exists
            }
        }

        function sortData(column) {
            if (sortColumn === column) {
                // Toggle direction if clicking same column
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, default to descending
                sortColumn = column;
                sortDirection = 'desc';
            }
            
            renderTable();
        }

        function applyFilters() {
            const packFilter = document.getElementById('packFilter').value;
            const cardFilter = document.getElementById('cardFilter').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();

            filteredData = allData.filter(row => {
                if (packFilter && row.packType !== packFilter) return false;
                if (cardFilter && !row.cardTypes.includes(cardFilter)) return false;
                if (searchText) {
                    const searchableText = (row.cleanFilename + row.deviceAccount + row.originalFilename).toLowerCase();
                    if (!searchableText.includes(searchText)) return false;
                }
                return true;
            });

            expandedAccounts.clear();
            renderTable();
        }

        function getCardDisplayName(cardType) {
            const type = cardType.toLowerCase();
            const translated = translateCardType(cardType);

            if (type === 'crown') return '<span class="card-star">ğŸ‘‘</span> <span class="card-crown">' + translated + '</span>';
            if (type === 'fullart') return '<span class="card-star">â˜…â˜…</span> <span class="card-fullart">' + translated + '</span>';
            if (type === 'trainer') return '<span class="card-star">â˜…â˜…</span> <span class="card-trainer">' + translated + '</span>';
            if (type === 'rainbow') return '<span class="card-star">â˜…â˜…</span> <span class="card-rainbow">' + translated + '</span>';
            if (type === 'shiny1star') return '<span class="card-star">â˜…</span> <span class="card-shiny">' + translated + '</span>';
            if (type === 'shiny2star') return '<span class="card-star">â˜…â˜…</span> <span class="card-shiny">' + translated + '</span>';
            if (type === '1star') return '<span class="card-star">â˜…</span> ' + translated;
            if (type === '2star') return '<span class="card-star">â˜…â˜…</span> ' + translated;
            if (type === 'immersive') return '<span class="card-immersive">' + translated + '</span>';
            if (type === '4diamond') return '<span class="card-diamond">â—†â—†â—†â—†</span>';
            if (type === '3diamond') return '<span class="card-diamond">â—†â—†â—†</span>';
            if (type === '2diamond') return '<span class="card-diamond">â—†â—†</span>';
            if (type === '1diamond') return '<span class="card-diamond">â—†</span>';
            return translated;
        }

        function aggregateByAccount(data) {
            const accountMap = new Map();
            
            data.forEach(row => {
                const key = row.deviceAccount;
                if (!accountMap.has(key)) {
                    accountMap.set(key, {
                        deviceAccount: row.deviceAccount,
                        firstSeen: row.timestamp,
                        lastSeen: row.timestamp,
                        totalPulls: 0,
                        packTypes: new Set(),
                        cards: new Map(),
                        details: []
                    });
                }
                
                const account = accountMap.get(key);
                account.totalPulls++;
                account.packTypes.add(row.packType);
                account.lastSeen = row.timestamp;
                account.details.push(row);
                
                row.cardTypes.forEach((cardType, idx) => {
                    const count = row.cardCounts[idx];
                    if (account.cards.has(cardType)) {
                        account.cards.set(cardType, account.cards.get(cardType) + count);
                    } else {
                        account.cards.set(cardType, count);
                    }
                });
            });
            
            return Array.from(accountMap.values());
        }

        function toggleAccount(deviceAccount) {
            if (expandedAccounts.has(deviceAccount)) {
                expandedAccounts.delete(deviceAccount);
            } else {
                expandedAccounts.add(deviceAccount);
            }
            renderTable();
        }

        function calculateAgeDays(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function renderTable() {
            const t = translations[currentLanguage];
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <h2>${csvLoaded ? t.noResults : t.noData}</h2>
                            <p>${csvLoaded ? t.tryFilters : t.clickLoad}</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const dateClass = sortColumn === 'date' ? `sorted-${sortDirection}` : '';
            const shinedustClass = sortColumn === 'shinedust' ? `sorted-${sortDirection}` : '';

            thead.innerHTML = `
                <tr>
                    <th class="col-account"><span data-i18n="deviceAccount">${t.deviceAccount}</span></th>
                    <th class="col-pack"><span data-i18n="pack">${t.pack}</span></th>
                    <th class="col-cards"><span data-i18n="cards">${t.cards}</span></th>
                    <th class="col-shinedust sortable ${shinedustClass}" onclick="sortData('shinedust')"><span data-i18n="shinedust">${t.shinedust}</span></th>
                    <th class="col-screenshot"><span data-i18n="screenshot">${t.screenshot}</span></th>
                    <th class="col-xml"><span data-i18n="xml">${t.xml}</span></th>
                    <th class="col-subTime sortable ${dateClass}" onclick="sortData('date')"><span data-i18n="date">${t.date}</span></th>
                    <th class="col-age"><span data-i18n="ageDays">${t.ageDays}</span></th>
                </tr>
            `;

            let aggregated = aggregateByAccount(filteredData);
            
            // Apply sorting
            if (sortColumn === 'date') {
                aggregated.sort((a, b) => {
                    const dateA = new Date(a.lastSeen);
                    const dateB = new Date(b.lastSeen);
                    return sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
                });
            } else if (sortColumn === 'shinedust') {
                aggregated.sort((a, b) => {
                    const shinedustA = a.details.length > 0 && a.details[a.details.length - 1].shinedust 
                        ? parseInt(a.details[a.details.length - 1].shinedust) 
                        : 0;
                    const shinedustB = b.details.length > 0 && b.details[b.details.length - 1].shinedust 
                        ? parseInt(b.details[b.details.length - 1].shinedust) 
                        : 0;
                    return sortDirection === 'asc' ? shinedustA - shinedustB : shinedustB - shinedustA;
                });
            }

            tbody.innerHTML = '';
            
            aggregated.forEach(account => {
                const tr = document.createElement('tr');
                const isExpanded = expandedAccounts.has(account.deviceAccount);
                tr.className = isExpanded ? 'expandable expanded' : 'expandable';
                
                const expandIcon = isExpanded ? 'â–¼' : 'â–¶';
                
                const cardsHTML = Array.from(account.cards.entries())
                    .map(([type, count]) => {
                        const typeLower = type.toLowerCase();
                        return `<span class="summary-badge"><span class="badge badge-card badge-${typeLower}">${getCardDisplayName(type)} Ã—${count}</span></span>`;
                    })
                    .join(' ');

                const packsHTML = Array.from(account.packTypes)
                    .filter(pack => pack && pack.length > 0)
                    .map(pack => `<span class="badge badge-pack">${translatePackType(pack)}</span>`)
                    .join(' ');

                const xmlFilenames = [...new Set(account.details.map(d => d.cleanFilename))].join(', ');
                const originalFileName = account.details.map(d => d.originalFilename).join(',');
                
                // Get latest shinedust value from the stored map (not affected by filtering)
                const latestShinedust = accountShinedustMap.get(account.deviceAccount) || '';

                const shinedust = latestShinedust !== '' ? parseInt(latestShinedust) : 0;
                const shinedustClass = shinedust >= 25000 ? 'shinedust-high' : (shinedust > 0 ? 'shinedust-low' : '');
                const shinedustHTML = latestShinedust !== '' ? `<span class="${shinedustClass}">${latestShinedust}</span>` : '';

                const ageDays = calculateAgeDays(account.firstSeen);

                tr.innerHTML = `
                    <td class="device-account">
                        <span class="expand-icon ${isExpanded ? 'expanded' : ''}">${expandIcon}</span>
                        ${shortenDeviceAccount(account.deviceAccount)}
                    </td>
                    <td>${packsHTML}</td>
                    <td class="col-cards"><div class="summary-stats">${cardsHTML}</div></td>
                    <td class="col-shinedust">${shinedustHTML}</td>
                    <td class="col-screenshot"></td>
                    <td class="col-xml">${xmlFilenames}&nbsp;&nbsp;&nbsp;<span class="xmlDownloadLink" data-info="${originalFileName}"><i class="fas fa-download"></i></span></td>
                    <td class="time-cell">${account.lastSeen.split(' ')[0]}</td>
                    <td class="col-age">${ageDays}</td>
                `;
                
                tr.onclick = () => toggleAccount(account.deviceAccount);
                tbody.appendChild(tr);

                if (isExpanded) {
                    let detailRowHtml = '';
                    let screenshotTag = '';
                    const validDetails = account.details.filter(detail => 
                        !(detail.packType.length == 0 && detail.shinedust > 0)
                    );
                    
                    validDetails.forEach((detail, index) => {
                        const detailTr = document.createElement('tr');
                        const isLastDetail = index === validDetails.length - 1;
                        detailTr.className = isLastDetail ? 'detail-row last-detail-row' : 'detail-row';
                        
                        const detailCardsHTML = detail.cardTypes.map((type, idx) => {
                            const typeLower = type.toLowerCase();
                            return `<span class="badge badge-card badge-${typeLower}">${getCardDisplayName(type)} Ã—${detail.cardCounts[idx]}</span>`;
                        }).join(' ');

                        const screenshotFileName = detail.packScreenshot.replace(/\n/g, "");

                        detailRowHtml = `
                            <td class="device-account"></td>
                            <td><span class="badge badge-pack">${translatePackType(detail.packType)}</span></td>
                            <td class="col-cards">${detailCardsHTML}</td>
                            <td class="col-shinedust"></td>
                            <td class="detail-screenshot">
                        `;
                        screenshotTag = ``;
                        if(screenshotFileName.trim().length > 0){
                            screenshotTag = `<img class="PackScreenshot" src="../../Screenshots/Trades/${screenshotFileName}">`;
                        }
                        detailRowHtml += screenshotTag;
                        detailRowHtml += `
                            </td>
                            <td class="col-xml" title="${detail.originalFilename}">${detail.cleanFilename}</td>
                            <td class="time-cell">${detail.timestamp}</td>
                            <td class="col-age"></td>
                        `;
                        detailTr.innerHTML = detailRowHtml;
                        
                        tbody.appendChild(detailTr);
                    });
                }
            });

            document.querySelectorAll('.PackScreenshot').forEach(el => {
                el.addEventListener('click', openPopup);
            });

            document.querySelectorAll('.xmlDownloadLink').forEach(el => {
                el.addEventListener('click', function(event) {
                    event.stopPropagation();
                    if (!filesUploaded) {
                        alert('Navigate to the /Accounts/Saved/ folder, then click "Upload".');
                        document.getElementById('xmlFileInput').click();
                    } else {
                        // Download the specific XML file for this row
                        const info = this.getAttribute('data-info');
                        const filenames = info.split(',');
                        const matchingFile = uploadedFiles.find(file => filenames.some(fn => fn.trim() === file.name));
                        if (matchingFile) {
                            const url = URL.createObjectURL(matchingFile);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = matchingFile.name;
                            a.click();
                            URL.revokeObjectURL(url);
                        } else {
                            alert('Matching XML file not found in uploaded files.');
                        }
                    }
                });
            });
        }

        function openPopup(event) {
            event.stopPropagation();
            const imgObj = event.currentTarget;
            const popupImg = document.getElementById('popup-img');

            popupImg.src = imgObj.src;
            popup.style.display = 'flex';
        }

        function exportFiltered() {
            const t = translations[currentLanguage];
            if (filteredData.length === 0) {
                alert(t.noResults);
                return;
            }

            const headers = 'Timestamp,OriginalFilename,CleanFilename,DeviceAccount,PackType,CardTypes,CardCounts,PackScreenshot,Shinedust\n';
            const rows = filteredData.map(row => 
                `${row.timestamp},${row.originalFilename},${row.cleanFilename},${row.deviceAccount},${row.packType},${row.cardTypes.join('|')},${row.cardCounts.join('|')},${row.packScreenshot},${row.shinedust || ''}`
            ).join('\n');

            const csv = headers + rows;
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trades_export_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</head>
<body>    
    <div class="popup-overlay" id="popup">
        <div class="popup-content">
            <img id="popup-img" src="" alt="Enlarged Image">
            <br>
            <button class="close-btn" id="closeBtn">Close</button>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1>save4trade database</h1>
            <p>for ptcgp bot (kevinnnn)</p>
            <div class="kofi-container">
                <a href="https://ko-fi.com/kevnitg" target="_blank" rel="noopener noreferrer">
                    <img src="../../GUI/images/support_me_on_kofi.png" alt="support me on ko-fi" />
                </a>
                <div class="language-selector">
                    <select id="languageSelect" onchange="changeLanguage()">
                        <option value="en">English</option>
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                        <option value="ko">í•œêµ­ì–´</option>
                        <option value="de">Deutsch</option>
                        <option value="fr">FranÃ§ais</option>
                        <option value="es">EspaÃ±ol</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="number" id="uniqueAccounts">0</div>
                <div class="label"><i class="fas fa-users"></i> unique accounts</div>
            </div>
            <div class="stat-card">
                <div class="number" id="totalCards">0</div>
                <div class="label"><i class="fas fa-layer-group"></i> total cards</div>
            </div>
        </div>

        <div class="controls">
            <div class="filter-group">
                <button class="btn" id="loadCSVBtn" onclick="document.getElementById('fileInput').click()"><i class="fas fa-upload"></i> load csv</button>
                <input type="file" id="fileInput" accept=".csv">
                <input type="file" id="xmlFileInput" webkitdirectory multiple style="display:none">

                <input type="text" id="searchInput" placeholder="search account..." disabled>

                <select id="packFilter" disabled>
                    <option value="">all packs</option>
                </select>

                <select id="cardFilter" disabled>
                    <option value="">all cards</option>
                </select>
                
                <button class="btn export-btn" onclick="exportFiltered()" id="exportBtn" disabled><i class="fas fa-download"></i> export</button>
            </div>
        </div>

        <div class="table-container">
            <table id="mainTable">
                <thead id="tableHead">
                    <tr>
                        <th class="col-account"><span data-i18n="deviceAccount">deviceAccount</span></th>
                        <th class="col-pack"><span data-i18n="pack">pack</span></th>
                        <th class="col-cards"><span data-i18n="cards">cards</span></th>
                        <th class="col-shinedust"><span data-i18n="shinedust">shinedust</span></th>
                        <th class="col-screenshot"><span data-i18n="screenshot">screenshot</span></th>
                        <th class="col-xml"><span data-i18n="xml">.xml</span></th>
                        <th class="col-subTime"><span data-i18n="date">date</span></th>
                        <th class="col-age"><span data-i18n="ageDays">age (days)</span></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="8" class="empty-state">
                            <h2>no data loaded</h2>
                            <p>click load csv to view database</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>
