<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>save4trade database</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #fafafa;
            padding: 20px;
            font-weight: 300;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border-radius: 12px;
            overflow: hidden;
        }

        .header {
            background: #1a1a1a;
            color: white;
            padding: 24px 32px;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 300;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .header p {
            font-size: 0.85em;
            opacity: 0.7;
            font-weight: 300;
        }

        .kofi-container {
            margin-top: 14px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .kofi-container a {
            display: inline-block;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .kofi-container a:hover {
            opacity: 1;
        }

        .kofi-container img {
            height: 37px;
            width: 185px;
            border-radius: 8px;
        }

        .language-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: -3px;
        }

        .language-selector::before {
            content: "üåê";
            font-size: 1.2em;
            opacity: 0.9;
        }

        .language-selector select {
            padding: 8px 32px 8px 12px;
            border: 1px solid #666;
            background: #2a2a2a;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 400;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"%3e%3cpolyline points="6 9 12 15 18 9"%3e%3c/polyline%3e%3c/svg%3e');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            transition: all 0.2s;
        }

        .language-selector select:hover {
            background-color: #3a3a3a;
            border-color: #888;
        }

        .language-selector select:focus {
            outline: none;
            border-color: #999;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .language-selector select option {
            padding: 8px 12px;
            background: #2a2a2a;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .stat-card {
            padding: 12px 20px;
            text-align: center;
            border-right: 1px solid #e0e0e0;
        }

        .stat-card:last-child {
            border-right: none;
        }

        .stat-card .number {
            font-size: 2em;
            font-weight: 300;
            color: #1a1a1a;
        }

        .stat-card .label {
            color: #999;
            margin-top: 4px;
            font-size: 0.75em;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        .xmlDownloadLink {
            color: #1a1a1a;
            font-size: 1.4em;
            font-weight: 400;
            text-decoration-line: none;
            cursor: pointer;
            display: inline-block;
            transition: transform 0.2s, color 0.2s;
            line-height: 1;
        }

        .xmlDownloadLink:hover {
            color: #0066cc;
            transform: scale(1.15);
        }

        .controls {
            padding: 16px 24px;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }

        .filter-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group label {
            font-weight: 400;
            color: #666;
            font-size: 0.85em;
        }

        .filter-group input[type="text"] {
            padding: 6px 12px;
            border: 1px solid #ddd;
            font-size: 0.85em;
            font-family: inherit;
            font-weight: 300;
            background: white;
            border-radius: 8px;
        }

        .filter-group input[type="text"]:focus {
            outline: none;
            border-color: #1a1a1a;
        }

        .filter-stack {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 0.8em;
            color: #555;
            font-weight: 500;
            letter-spacing: 0.2px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: white;
            max-height: 140px;
            overflow-y: auto;
            min-width: 220px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            background: #fafafa;
            font-size: 0.85em;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
            user-select: none;
        }

        .checkbox-item:hover {
            border-color: #ccc;
            background: #f5f5f5;
        }

        .select-all-buttons {
            display: flex;
            gap: 8px;
            margin-top: 4px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .select-all-buttons .btn {
            padding: 4px 12px;
            font-size: 0.8em;
            min-width: 100px;
        }

        .checkbox-item input {
            accent-color: #1a1a1a;
            cursor: pointer;
        }

        .btn {
            background: white;
            color: #1a1a1a;
            border: 1px solid #1a1a1a;
            padding: 6px 16px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 400;
            font-family: inherit;
            transition: all 0.2s;
            border-radius: 8px;
        }

        .btn:hover {
            background: #1a1a1a;
            color: white;
        }

        .btn.active {
            background: #1a1a1a;
            color: white;
        }

        .btn:disabled,
        select:disabled,
        input:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .table-container {
            padding: 24px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th {
            background: #fafafa;
            padding: 10px 12px;
            text-align: left;
            font-weight: bold;
            color: #000000;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.8em;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        th.sortable:hover {
            background: #efefef;
        }

        th.sortable::after {
            content: " ‚áÖ";
            opacity: 0.3;
            font-size: 0.9em;
        }

        th.sortable.sorted-asc::after {
            content: " ‚ñ≤";
            opacity: 1;
            color: #1a1a1a;
        }

        th.sortable.sorted-desc::after {
            content: " ‚ñº";
            opacity: 1;
            color: #1a1a1a;
        }

        th.col-account {
            width: 70px;
            max-width: 70px;
        }

        th.col-time {
            width: 80px;
            max-width: 80px;
            font-size: 0.8em;
        }

        th.col-pack {
            width: 80px;
            max-width: 80px;
        }

        th.col-xml {
            width: 65px;
            max-width: 65px;
        }

        th.col-cards {
            width: 90px;
            max-width: 90px;
        }

        th.col-screenshot {
            width: 120px;
            max-width: 120px;
            font-size: 0.8em;
        }

        th.col-shinedust {
            width: 70px;
            max-width: 70px;
            font-size: 0.8em;
        }

        th.col-subTime {
            width: 80px;
            max-width: 80px;
            font-size: 0.8em;
        }

        th.col-age {
            width: 70px;
            max-width: 70px;
            font-size: 0.8em;
            text-align: center;
        }

        td.col-age {
            width: 70px;
            max-width: 70px;
            font-size: 0.85em;
            text-align: center;
            color: #666;
        }

        .expandable {
            cursor: pointer;
            transition: background 0.2s;
        }

        .expandable:hover {
            background: #f5f5f5;
        }

        .expandable.expanded {
            background: #e8f4f8;
            border-left: 3px solid #4a90e2;
        }

        .detail-row {
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
            border-left: 3px solid #4a90e2;
        }

        .detail-row.last-detail-row {
            border-bottom: 3px solid #4a90e2;
            margin-bottom: 4px;
        }

        .detail-row td {
            font-size: 0.75em;
            color: #666;
            padding: 8px 12px;
        }

        td {
            padding: 8px 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.85em;
        }

        .summary-stats {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .summary-badge {
            display: inline-block;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 0.9em;
            font-weight: 400;
            margin: 2px;
            border: 1px solid;
            border-radius: 12px;
        }

        .badge-pack {
            background: #f0f0f0;
            color: #1a1a1a;
            border-color: #ddd;
            font-size: 0.95em;
            border-radius: 12px;
        }

        .badge-card {
            background: white;
            color: #1a1a1a;
            border-color: #999;
            font-size: 0.9em;
            border-radius: 12px;
        }

        /* Card type specific colors */
        .badge-crown {
            background: #FFF8DC !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-4diamond {
            background: #E3F2FD !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-3diamond {
            background: #E8F5E9 !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-2diamond {
            background: #FFF3E0 !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-1diamond {
            background: #FFEBEE !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-rainbow {
            background: linear-gradient(90deg,
                #FFB3BA 0%,
                #FFDFBA 16.67%,
                #FFFFBA 33.33%,
                #BAFFBA 50%,
                #BAE1FF 66.67%,
                #D7BAFF 83.33%,
                #FFB3D9 100%) !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-shiny1star,
        .badge-shiny2star {
            background: linear-gradient(45deg, #B8B8B8, #D8D8D8) !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-1star,
        .badge-2star {
            background: #FFFDE7 !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-immersive {
            background: linear-gradient(135deg, #E8D5F2 0%, #D1C4E9 50%, #B39DDB 100%) !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-fullart {
            background: #C8E6C9 !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .badge-trainer {
            background: #BBDEFB !important;
            border-color: #000000 !important;
            color: #000000 !important;
        }

        .card-crown {
            color: #B8860B;
            font-weight: 500;
        }

        .card-diamond {
            font-weight: 500;
        }

        .card-rainbow {
            color: #6A1B9A;
            font-weight: 600;
        }

        .card-shiny {
            color: #666;
            font-weight: 500;
        }

        .card-immersive {
            color: #4A148C;
            font-weight: 600;
        }

        .card-fullart {
            color: #6A1B9A;
            font-weight: 500;
        }

        .card-trainer {
            color: #C62828;
            font-weight: 500;
        }

        .card-star {
            color: #DAA520;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-weight: 300;
        }

        .empty-state h2 {
            margin-bottom: 8px;
            font-weight: 300;
        }

        #fileInput {
            display: none;
        }

        .export-btn {
            background: #1a1a1a;
            color: white;
        }

        .export-btn:hover {
            background: #333;
        }

        .device-account {
            width: 80px;
            max-width: 80px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.8em;
            color: #000000;
            font-weight: 300;
        }

        .detail-screenshot {
            width: 120px;
            max-width: 120px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.75em;
            color: #000000;
            font-weight: 300;
        }

        .time-cell {
            width: 130px;
            font-size: 0.7em;
            color: #999;
        }

        .expand-icon {
            display: inline-block;
            width: 16px;
            text-align: center;
            margin-right: 8px;
            color: #666;
            font-size: 0.9em;
        }

        .expand-icon.expanded {
            transform: rotate(0deg);
        }

        .PackScreenshot {
            max-width: 110px;
            max-height: 80px;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: transform 0.2s;
            border-radius: 8px;
        }

        .PackScreenshot:hover {
            transform: scale(1.05);
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            max-width: 90%;
            max-height: 90%;
            text-align: center;
        }

        .popup-content img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .close-btn {
            display: block;
            margin: 20px auto 0;
            padding: 10px 30px;
            background: white;
            color: #1a1a1a;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.2s;
            border-radius: 8px;
        }

        .close-btn:hover {
            background: #f0f0f0;
        }

        .shinedust-high {
            color: #00cc00;
            font-weight: 500;
        }

        .shinedust-low {
            color: #cc0000;
            font-weight: 500;
        }

        .col-xml {
            font-size: 0.7em;
        }

    </style>
    <script>
        // Translation dictionary
        const translations = {
            en: {
                uniqueAccounts: "unique accounts",
                totalCards: "total cards",
                loadCSV: "load csv",
                expandAll: "expand all",
                collapseAll: "collapse all",
                allPacks: "all packs",
                allCards: "all cards",
                searchPlaceholder: "search account...",
                exportBtn: "export",
                deviceAccount: "deviceAccount",
                pack: "pack",
                cards: "cards",
                xml: ".xml",
                shinedust: "shinedust",
                screenshot: "screenshot",
                date: "date",
                ageDays: "age (days)",
                noData: "no data loaded",
                clickLoad: "click load csv to view database",
                noResults: "no results",
                tryFilters: "try different filters",
                // Pack names
                megagyarados: "Mega Gyarados",
                megablaziken: "Mega Blaziken",
                megaaltaria: "Mega Altaria",
                deluxe: "Deluxe",
                springs: "Springs",
                hooh: "Ho-Oh",
                lugia: "Lugia",
                eevee: "Eevee",
                buzzwole: "Extradimensional Crisis",
                solgaleo: "Solgaleo",
                lunala: "Lunala",
                shining: "Shining",
                arceus: "Arceus",
                palkia: "Palkia",
                dialga: "Dialga",
                pikachu: "Pikachu",
                charizard: "Charizard",
                mewtwo: "Mewtwo",
                mew: "Mew",
                // Card types
                crown: "Crown",
                fullart: "Full Art",
                trainer: "Trainer",
                rainbow: "Rainbow",
                shiny1star: "Shiny",
                shiny2star: "Shiny",
                "1star": "1 Star",
                "2star": "2 Star",
                immersive: "Immersive",
                "4diamond": "‚óÜ‚óÜ‚óÜ‚óÜ",
                "3diamond": "‚óÜ‚óÜ‚óÜ",
                "2diamond": "‚óÜ‚óÜ",
                "1diamond": "‚óÜ",
                selectAll: "select all",
                deselectAll: "deselect all"
            },
            zh: {
                uniqueAccounts: "Áã¨ÁâπÂ∏êÊà∑",
                totalCards: "ÊÄªÂç°Êï∞",
                loadCSV: "Âä†ËΩΩ csv",
                expandAll: "ÂÖ®ÈÉ®Â±ïÂºÄ",
                collapseAll: "ÂÖ®ÈÉ®ÊäòÂè†",
                allPacks: "ÊâÄÊúâÂç°ÂåÖ",
                allCards: "ÊâÄÊúâÂç°Áâå",
                searchPlaceholder: "ÊêúÁ¥¢Â∏êÊà∑...",
                exportBtn: "ÂØºÂá∫",
                deviceAccount: "ËÆæÂ§áÂ∏êÊà∑",
                pack: "Âç°ÂåÖ",
                cards: "Âç°Áâå",
                xml: ".xml",
                shinedust: "Èó™ÂÖâÂ∞ò",
                screenshot: "Êà™Âõæ",
                date: "Êó•Êúü",
                ageDays: "Â§©Êï∞",
                noData: "Êú™Âä†ËΩΩÊï∞ÊçÆ",
                clickLoad: "ÁÇπÂáªÂä†ËΩΩ csv Êü•ÁúãÊï∞ÊçÆÂ∫ì",
                noResults: "Êó†ÁªìÊûú",
                tryFilters: "Â∞ùËØï‰∏çÂêåÁöÑÁ≠õÈÄâÂô®",
                // Pack names
                megagyarados: "Ë∂ÖÁ¥öÊö¥ÈØâÈæç",
                megablaziken: "Ë∂ÖÁ¥öÁÅ´ÁÑ∞Èõû",
                megaaltaria: "Ë∂ÖÁ¥ö‰∏ÉÂ§ïÈùíÈ≥•",
                deluxe: "Ë±™ËèØ",
                springs: "Ê∫´Ê≥â",
                hooh: "È≥≥Áéã",
                lugia: "Ê¥õÂ•á‰∫û",
                eevee: "‰ºäÂ∏É",
                buzzwole: "Áï∞Ê¨°ÂÖÉÂç±Ê©ü",
                solgaleo: "Á¥¢ÁàæËø¶Èõ∑Ê≠ê",
                lunala: "Èú≤Â•àÈõÖÊãâ",
                shining: "ÈñÉËÄÄ",
                arceus: "ÈòøÁàæÂÆôÊñØ",
                palkia: "Â∏ïË∑ØÂ•á‰∫û",
                dialga: "Â∏ùÁâôÁõßÂç°",
                pikachu: "ÁöÆÂç°‰∏ò",
                charizard: "Âô¥ÁÅ´Èæç",
                mewtwo: "Ë∂ÖÂ§¢",
                mew: "Â§¢Âπª",
                // Card types
                crown: "ÁéãÂÜ†",
                fullart: "ÂÖ®ÊÅØ",
                trainer: "ËÆ≠ÁªÉÂÆ∂",
                rainbow: "ÂΩ©Ëôπ",
                shiny1star: "Èó™Âç°",
                shiny2star: "Èó™Âç°",
                "1star": "1Êòü",
                "2star": "2Êòü",
                immersive: "Ê≤âÊµ∏Âºè",
                "4diamond": "‚óÜ‚óÜ‚óÜ‚óÜ",
                "3diamond": "‚óÜ‚óÜ‚óÜ",
                "2diamond": "‚óÜ‚óÜ",
                "1diamond": "‚óÜ",
                selectAll: "ÂÖ®ÈÄâ",
                deselectAll: "ÂèñÊ∂àÂÖ®ÈÄâ"
            },
            ja: {
                uniqueAccounts: "Âõ∫Êúâ„Ç¢„Ç´„Ç¶„É≥„Éà",
                totalCards: "ÂêàË®à„Ç´„Éº„ÉâÊï∞",
                loadCSV: "csvË™≠„ÅøËæº„Åø",
                expandAll: "„Åô„Åπ„Å¶Â±ïÈñã",
                collapseAll: "„Åô„Åπ„Å¶Êäò„Çä„Åü„Åü„ÇÄ",
                allPacks: "„Åô„Åπ„Å¶„ÅÆ„Éë„ÉÉ„ÇØ",
                allCards: "„Åô„Åπ„Å¶„ÅÆ„Ç´„Éº„Éâ",
                searchPlaceholder: "„Ç¢„Ç´„Ç¶„É≥„ÉàÊ§úÁ¥¢...",
                exportBtn: "„Ç®„ÇØ„Çπ„Éù„Éº„Éà",
                deviceAccount: "„Éá„Éê„Ç§„Çπ„Ç¢„Ç´„Ç¶„É≥„Éà",
                pack: "„Éë„ÉÉ„ÇØ",
                cards: "„Ç´„Éº„Éâ",
                xml: ".xml",
                shinedust: "„Ç∑„É£„Ç§„É≥„ÉÄ„Çπ„Éà",
                screenshot: "„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà",
                date: "Êó•‰ªò",
                ageDays: "Êó•Êï∞",
                noData: "„Éá„Éº„Çø„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì",
                clickLoad: "csv„ÇíË™≠„ÅøËæº„Çì„Åß„Éá„Éº„Çø„Éô„Éº„Çπ„ÇíË°®Á§∫",
                noResults: "ÁµêÊûú„Å™„Åó",
                tryFilters: "Âà•„ÅÆ„Éï„Ç£„É´„Çø„Éº„ÇíË©¶„Åô",
                // Pack names
                megagyarados: "„É°„Ç¨„ÇÆ„É£„É©„Éâ„Çπ",
                megablaziken: "„É°„Ç¨„Éê„Ç∑„É£„Éº„É¢",
                megaaltaria: "„É°„Ç¨„ÉÅ„É´„Çø„É™„Çπ",
                deluxe: "„Éá„É©„ÉÉ„ÇØ„Çπ",
                springs: "Ê∏©Ê≥â",
                hooh: "„Éõ„Ç¶„Ç™„Ç¶",
                lugia: "„É´„ÇÆ„Ç¢",
                eevee: "„Ç§„Éº„Éñ„Ç§",
                buzzwole: "Áï∞Ê¨°ÂÖÉ„ÅÆÂç±Ê©ü",
                solgaleo: "„ÇΩ„É´„Ç¨„É¨„Ç™",
                lunala: "„É´„Éä„Ç¢„Éº„É©",
                shining: "„Ç∑„É£„Ç§„Éã„É≥„Ç∞",
                arceus: "„Ç¢„É´„Çª„Ç¶„Çπ",
                palkia: "„Éë„É´„Ç≠„Ç¢",
                dialga: "„Éá„Ç£„Ç¢„É´„Ç¨",
                pikachu: "„Éî„Ç´„ÉÅ„É•„Ç¶",
                charizard: "„É™„Ç∂„Éº„Éâ„É≥",
                mewtwo: "„Éü„É•„Ç¶„ÉÑ„Éº",
                mew: "„Éü„É•„Ç¶",
                // Card types
                crown: "„ÇØ„É©„Ç¶„É≥",
                fullart: "„Éï„É´„Ç¢„Éº„Éà",
                trainer: "„Éà„É¨„Éº„Éä„Éº",
                rainbow: "„É¨„Ç§„É≥„Éú„Éº",
                shiny1star: "„Ç∑„É£„Ç§„Éã„Éº",
                shiny2star: "„Ç∑„É£„Ç§„Éã„Éº",
                "1star": "1„Å§Êòü",
                "2star": "2„Å§Êòü",
                immersive: "„Ç§„Éû„Éº„Ç∑„Éñ",
                "4diamond": "‚óÜ‚óÜ‚óÜ‚óÜ",
                "3diamond": "‚óÜ‚óÜ‚óÜ",
                "2diamond": "‚óÜ‚óÜ",
                "1diamond": "‚óÜ",
                selectAll: "„Åô„Åπ„Å¶ÈÅ∏Êäû",
                deselectAll: "„Åô„Åπ„Å¶ÈÅ∏ÊäûËß£Èô§"
            },
            de: {
                uniqueAccounts: "eindeutige Konten",
                totalCards: "Gesamtkarten",
                loadCSV: "csv laden",
                expandAll: "alle √∂ffnen",
                collapseAll: "alle schlie√üen",
                allPacks: "alle Packs",
                allCards: "alle Karten",
                searchPlaceholder: "Konto suchen...",
                exportBtn: "exportieren",
                deviceAccount: "Ger√§tekonto",
                pack: "Pack",
                cards: "Karten",
                xml: ".xml",
                shinedust: "Glitzerstaub",
                screenshot: "Screenshot",
                date: "Datum",
                ageDays: "Alter (Tage)",
                noData: "keine Daten geladen",
                clickLoad: "csv laden, um Datenbank anzuzeigen",
                noResults: "keine Ergebnisse",
                tryFilters: "andere Filter versuchen",
                // Pack names
                megagyarados: "Mega-Garados",
                megablaziken: "Mega-Lohgock",
                megaaltaria: "Mega-Altaria",
                deluxe: "Deluxe",
                springs: "Quellen",
                hooh: "Ho-Oh",
                lugia: "Lugia",
                eevee: "Evoli",
                buzzwole: "Interdimensionale Krise",
                solgaleo: "Solgaleo",
                lunala: "Lunala",
                shining: "Gl√§nzend",
                arceus: "Arceus",
                palkia: "Palkia",
                dialga: "Dialga",
                pikachu: "Pikachu",
                charizard: "Glurak",
                mewtwo: "Mewtu",
                mew: "Mew",
                // Card types
                crown: "Krone",
                fullart: "Vollkunst",
                trainer: "Trainer",
                rainbow: "Regenbogen",
                shiny1star: "Gl√§nzend",
                shiny2star: "Gl√§nzend",
                "1star": "1 Stern",
                "2star": "2 Sterne",
                immersive: "Immersiv",
                "4diamond": "‚óÜ‚óÜ‚óÜ‚óÜ",
                "3diamond": "‚óÜ‚óÜ‚óÜ",
                "2diamond": "‚óÜ‚óÜ",
                "1diamond": "‚óÜ",
                selectAll: "Alle ausw√§hlen",
                deselectAll: "Alle abw√§hlen"
            },
            fr: {
                uniqueAccounts: "comptes uniques",
                totalCards: "total de cartes",
                loadCSV: "charger csv",
                expandAll: "tout d√©plier",
                collapseAll: "tout replier",
                allPacks: "tous les paquets",
                allCards: "toutes les cartes",
                searchPlaceholder: "rechercher un compte...",
                exportBtn: "exporter",
                deviceAccount: "compte appareil",
                pack: "paquet",
                cards: "cartes",
                xml: ".xml",
                shinedust: "poussi√®re brillante",
                screenshot: "capture d'√©cran",
                date: "date",
                ageDays: "√¢ge (jours)",
                noData: "aucune donn√©e charg√©e",
                clickLoad: "cliquez sur charger csv pour voir la base de donn√©es",
                noResults: "aucun r√©sultat",
                tryFilters: "essayez diff√©rents filtres",
                // Pack names
                megagyarados: "M√©ga-L√©viator",
                megablaziken: "M√©ga-Bras√©gali",
                megaaltaria: "M√©ga-Altaria",
                deluxe: "Deluxe",
                springs: "Sources",
                hooh: "Ho-Oh",
                lugia: "Lugia",
                eevee: "√âvoli",
                buzzwole: "Crise Extradimensionnelle",
                solgaleo: "Solgaleo",
                lunala: "Lunala",
                shining: "Brillant",
                arceus: "Arceus",
                palkia: "Palkia",
                dialga: "Dialga",
                pikachu: "Pikachu",
                charizard: "Dracaufeu",
                mewtwo: "Mewtwo",
                mew: "Mew",
                // Card types
                crown: "Couronne",
                fullart: "Art Complet",
                trainer: "Dresseur",
                rainbow: "Arc-en-ciel",
                shiny1star: "Brillant",
                shiny2star: "Brillant",
                "1star": "1 √âtoile",
                "2star": "2 √âtoiles",
                immersive: "Immersif",
                "4diamond": "‚óÜ‚óÜ‚óÜ‚óÜ",
                "3diamond": "‚óÜ‚óÜ‚óÜ",
                "2diamond": "‚óÜ‚óÜ",
                "1diamond": "‚óÜ",
                selectAll: "Tout s√©lectionner",
                deselectAll: "Tout d√©s√©lectionner"
            },
            ko: {
                uniqueAccounts: "Í≥†Ïú† Í≥ÑÏ†ï",
                totalCards: "Ï¥ù Ïπ¥Îìú",
                loadCSV: "csv Î°úÎìú",
                expandAll: "Î™®Îëê ÌéºÏπòÍ∏∞",
                collapseAll: "Î™®Îëê Ï†ëÍ∏∞",
                allPacks: "Î™®Îì† Ìå©",
                allCards: "Î™®Îì† Ïπ¥Îìú",
                searchPlaceholder: "Í≥ÑÏ†ï Í≤ÄÏÉâ...",
                exportBtn: "ÎÇ¥Î≥¥ÎÇ¥Í∏∞",
                deviceAccount: "Í∏∞Í∏∞ Í≥ÑÏ†ï",
                pack: "Ìå©",
                cards: "Ïπ¥Îìú",
                xml: ".xml",
                shinedust: "ÏÉ§Ïù∏ÎçîÏä§Ìä∏",
                screenshot: "Ïä§ÌÅ¨Î¶∞ÏÉ∑",
                date: "ÎÇ†Ïßú",
                ageDays: "ÎÇòÏù¥ (Ïùº)",
                noData: "Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏùå",
                clickLoad: "Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Î•º Î≥¥Î†§Î©¥ csv Î°úÎìúÎ•º ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî",
                noResults: "Í≤∞Í≥º ÏóÜÏùå",
                tryFilters: "Îã§Î•∏ ÌïÑÌÑ∞Î•º ÏãúÎèÑÌïòÏÑ∏Ïöî",
                // Pack names
                megagyarados: "Î©îÍ∞ÄÍ∞∏ÎùºÎèÑÏä§",
                megablaziken: "Î©îÍ∞ÄÎ≤àÏπòÏΩî",
                megaaltaria: "Î©îÍ∞ÄÌååÎπÑÏΩîÎ¶¨",
                deluxe: "ÎîîÎü≠Ïä§",
                springs: "Ïò®Ï≤ú",
                hooh: "Ïπ†ÏÉâÏ°∞",
                lugia: "Î£®Í∏∞ÏïÑ",
                eevee: "Ïù¥Î∏åÏù¥",
                buzzwole: "Ïù¥Ï∞®Ïõê ÏúÑÍ∏∞",
                solgaleo: "ÏÜîÍ∞ÄÎ†àÏò§",
                lunala: "Î£®ÎÇòÏïÑÎùº",
                shining: "ÏÉ§Ïù¥Îãù",
                arceus: "ÏïÑÎ•¥ÏÑ∏Ïö∞Ïä§",
                palkia: "ÌéÑÍ∏∞ÏïÑ",
                dialga: "ÎîîÏïÑÎ£®Í∞Ä",
                pikachu: "ÌîºÏπ¥Ï∏Ñ",
                charizard: "Î¶¨ÏûêÎ™Ω",
                mewtwo: "ÎÆ§Ï∏†",
                mew: "ÎÆ§",
                // Card types
                crown: "ÌÅ¨ÎùºÏö¥",
                fullart: "ÌíÄÏïÑÌä∏",
                trainer: "Ìä∏Î†àÏù¥ÎÑà",
                rainbow: "Î†àÏù∏Î≥¥Ïö∞",
                shiny1star: "ÏÉ§Ïù¥Îãà",
                shiny2star: "ÏÉ§Ïù¥Îãà",
                "1star": "1Ïä§ÌÉÄ",
                "2star": "2Ïä§ÌÉÄ",
                immersive: "Ïù¥Î®∏ÏãúÎ∏å",
                "4diamond": "‚óÜ‚óÜ‚óÜ‚óÜ",
                "3diamond": "‚óÜ‚óÜ‚óÜ",
                "2diamond": "‚óÜ‚óÜ",
                "1diamond": "‚óÜ",
                selectAll: "Î™®Îëê ÏÑ†ÌÉù",
                deselectAll: "Î™®Îëê ÏÑ†ÌÉù Ìï¥Ï†ú"
            },
            es: {
                uniqueAccounts: "cuentas √∫nicas",
                totalCards: "total de cartas",
                loadCSV: "cargar csv",
                expandAll: "expandir todo",
                collapseAll: "contraer todo",
                allPacks: "todos los sobres",
                allCards: "todas las cartas",
                searchPlaceholder: "buscar cuenta...",
                exportBtn: "exportar",
                deviceAccount: "cuenta dispositivo",
                pack: "sobre",
                cards: "cartas",
                xml: ".xml",
                shinedust: "polvo brillante",
                screenshot: "captura de pantalla",
                date: "fecha",
                ageDays: "edad (d√≠as)",
                noData: "no hay datos cargados",
                clickLoad: "haga clic en cargar csv para ver la base de datos",
                noResults: "sin resultados",
                tryFilters: "pruebe diferentes filtros",
                // Pack names
                megagyarados: "Mega Gyarados",
                megablaziken: "Mega Blaziken",
                megaaltaria: "Mega Altaria",
                deluxe: "Deluxe",
                springs: "Fuentes",
                hooh: "Ho-Oh",
                lugia: "Lugia",
                eevee: "Eevee",
                buzzwole: "Crisis Extradimensional",
                solgaleo: "Solgaleo",
                lunala: "Lunala",
                shining: "Brillante",
                arceus: "Arceus",
                palkia: "Palkia",
                dialga: "Dialga",
                pikachu: "Pikachu",
                charizard: "Charizard",
                mewtwo: "Mewtwo",
                mew: "Mew",
                // Card types
                crown: "Corona",
                fullart: "Arte Completo",
                trainer: "Entrenador",
                rainbow: "Arco√≠ris",
                shiny1star: "Brillante",
                shiny2star: "Brillante",
                "1star": "1 Estrella",
                "2star": "2 Estrellas",
                immersive: "Inmersivo",
                "4diamond": "‚óÜ‚óÜ‚óÜ‚óÜ",
                "3diamond": "‚óÜ‚óÜ‚óÜ",
                "2diamond": "‚óÜ‚óÜ",
                "1diamond": "‚óÜ",
                selectAll: "Seleccionar todo",
                deselectAll: "Deseleccionar todo"
            }
        };

        let currentLanguage = 'en';
        let allData = [];
        let filteredData = [];
        let expandedAccounts = new Set();
        let csvLoaded = false;
        let sortColumn = null;
        let sortDirection = 'desc'; // 'asc' or 'desc'
        let accountShinedustMap = new Map(); // Store latest shinedust for each account
        let filesUploaded = false;
        let uploadedFiles = new Map(); // mapping from deviceAccount -> File
        let allExpanded = false;

        function changeLanguage() {
            const select = document.getElementById('languageSelect');
            currentLanguage = select.value;

            updateUIText();
            if (csvLoaded) {
                populatePackFilter();
                updateCardFilter();
                renderTable();
            }
        }

        function updateUIText() {
            const t = translations[currentLanguage];

            // Update stats labels (use innerHTML to preserve icons)
            document.querySelector('#uniqueAccounts').nextElementSibling.innerHTML = '<i class="fas fa-users"></i> ' + t.uniqueAccounts;
            document.querySelector('#totalCards').nextElementSibling.innerHTML = '<i class="fas fa-layer-group"></i> ' + t.totalCards;

            // Update table headers
            const headerElements = document.querySelectorAll('[data-i18n]');
            headerElements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });

            // Update button if visible (use innerHTML to preserve icons)
            const loadBtn = document.getElementById('loadCSVBtn');
            if (loadBtn && loadBtn.style.display !== 'none') {
                loadBtn.innerHTML = '<i class="fas fa-upload"></i> ' + t.loadCSV;
            }

            document.getElementById('searchInput').placeholder = t.searchPlaceholder;
            // Update export button (use innerHTML to preserve icons)
            document.getElementById('exportBtn').innerHTML = '<i class="fas fa-download"></i> ' + t.exportBtn;

            // Update empty state if visible
            const emptyState = document.querySelector('.empty-state');
            if (emptyState) {
                const h2 = emptyState.querySelector('h2');
                const p = emptyState.querySelector('p');
                if (h2 && p) {
                    if (!csvLoaded) {
                        h2.textContent = t.noData;
                        p.textContent = t.clickLoad;
                    } else {
                        h2.textContent = t.noResults;
                        p.textContent = t.tryFilters;
                    }
                }
            }

            updateExpandButtonText();
        }

        function updateExpandButtonText() {
            const btn = document.getElementById('expandToggleBtn');
            if (!btn) return;
            const t = translations[currentLanguage] || translations.en;
            const label = allExpanded
                ? (t.collapseAll || translations.en.collapseAll)
                : (t.expandAll || translations.en.expandAll);
            const iconClass = allExpanded ? 'fa-compress' : 'fa-expand';
            btn.innerHTML = `<i class="fas ${iconClass}"></i> ${label}`;
            btn.classList.toggle('active', allExpanded);
        }

        function toggleExpandAll() {
            if (!csvLoaded) return;

            if (allExpanded) {
                allExpanded = false;
                expandedAccounts.clear();
            } else {
                const accounts = filteredData.map(row => row.deviceAccount);
                expandedAccounts = new Set(accounts);
                allExpanded = expandedAccounts.size > 0;
            }

            renderTable();
        }

        function translatePackType(packType) {
            if (!packType) return packType;
            const t = translations[currentLanguage];
            const key = packType.toLowerCase().replace(/[^a-z0-9]/g, '');
            return t[key] || packType;
        }

        function translateCardType(cardType) {
            if (!cardType) return cardType;
            const t = translations[currentLanguage];
            const key = cardType.toLowerCase().replace(/[^a-z0-9]/g, '');
            return t[key] || cardType;
        }

        function shortenDeviceAccount(account) {
            if (!account || account.length <= 6) return account;
            return account.substring(0, 5) + '..';
        }

        function makeSafeId(prefix, value) {
            const safeValue = (value || 'item').toString().replace(/[^a-zA-Z0-9_-]/g, '');
            return `${prefix}-${safeValue || 'option'}`;
        }

        function extractDeviceAccount(xmlText) {
            if (!xmlText) return "";
            const match = xmlText.match(
                /<string\s+name=["']deviceAccount["']>([^<]+)<\/string>/i
            );
            return match ? match[1].trim() : "";
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result || "");
                reader.onerror = () => reject(reader.error);
                reader.readAsText(file);
            });
        }

        async function handleXmlUpload(fileList) {
            const xmlFiles = Array.from(fileList || []).filter((file) =>
                file.name.toLowerCase().endsWith(".xml")
            );

            uploadedFiles = new Map();
            filesUploaded = false;

            if (xmlFiles.length === 0) {
                alert("No XML files selected. Please choose XML files.");
                return;
            }

            const tasks = xmlFiles.map(
                (file) =>
                    readFileAsText(file)
                        .then((text) => {
                            const deviceAccount =
                                extractDeviceAccount(text);
                            if (deviceAccount) {
                                uploadedFiles.set(deviceAccount, file);
                            }
                        })
                        .catch(() => {}) // ignore invalid files
            );

            await Promise.all(tasks);
            filesUploaded = uploadedFiles.size > 0;

            const processedCount = uploadedFiles.size;
            const message = filesUploaded
                ? `Uploaded ${processedCount} files. You can now download them.`
                : "No valid files found.";
            alert(message);
        }

        function getCheckedValues(containerId) {
            return Array.from(document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`))
                .map(cb => cb.value);
        }

        function selectAllCheckboxes(containerId) {
            const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
            checkboxes.forEach(cb => {
                cb.checked = true;
            });
            // Trigger the change event to update filters
            document.getElementById(containerId).onchange();
        }

        function deselectAllCheckboxes(containerId) {
            const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            // Trigger the change event to update filters
            document.getElementById(containerId).onchange();
        }

        function addSelectAllButtons(containerId) {
            // Find the filter-stack that contains our container
            const container = document.getElementById(containerId);
            const filterStack = container.closest('.filter-stack');

            if (!filterStack) return;

            // Check if buttons already exist to avoid duplicates
            const existingButtons = filterStack.querySelector('.select-all-buttons');
            if (existingButtons) {
                existingButtons.remove();
            }

            // Create buttons container
            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'select-all-buttons';
            buttonsContainer.style.marginTop = '4px';
            buttonsContainer.style.marginBottom = '8px';
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.gap = '8px';

            // Create Select All button
            const selectAllBtn = document.createElement('button');
            selectAllBtn.className = 'btn';
            selectAllBtn.textContent = translations[currentLanguage].selectAll || 'Select All';
            selectAllBtn.onclick = () => selectAllCheckboxes(containerId);

            // Create Deselect All button
            const deselectAllBtn = document.createElement('button');
            deselectAllBtn.className = 'btn';
            deselectAllBtn.textContent = translations[currentLanguage].deselectAll || 'Deselect All';
            deselectAllBtn.onclick = () => deselectAllCheckboxes(containerId);

            buttonsContainer.appendChild(selectAllBtn);
            buttonsContainer.appendChild(deselectAllBtn);

            // Insert buttons after the filter-label but before the checkbox container
            const filterLabel = filterStack.querySelector('.filter-label');
            if (filterLabel) {
                filterLabel.insertAdjacentElement('afterend', buttonsContainer);
            } else {
                // Fallback: insert at the beginning of the filter-stack
                filterStack.insertBefore(buttonsContainer, filterStack.firstChild);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const popup = document.getElementById('popup');
            const closeBtn = document.getElementById('closeBtn');

            closeBtn.addEventListener('click', () => {
                popup.style.display = 'none';
            });

            popup.addEventListener('click', e => {
                if (e.target === popup) popup.style.display = 'none';
            });

            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') popup.style.display = 'none';
            });

            document.getElementById('xmlFileInput').addEventListener('change', function(e) {
                handleXmlUpload(e.target.files);
            });

            document.getElementById('fileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    parseCSV(event.target.result);
                };
                reader.readAsText(file);
            });
        });

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');

            allData = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                const values = lines[i].split(',');
                const row = {
                    timestamp: values[0],
                    originalFilename: values[1],
                    cleanFilename: values[2],
                    deviceAccount: values[3],
                    packType: values[4],
                    cardTypes: values[5] ? values[5].split('|') : [],
                    cardCounts: values[6] ? values[6].split('|').map(Number) : [],
                    packScreenshot: values[7] ? values[7].trim() : '',
                    shinedust: values[8] ? values[8].trim() : '',
                };
                allData.push(row);
            }

            filteredData = [...allData];
            expandedAccounts.clear();
            allExpanded = false;
            csvLoaded = true;
            sortColumn = 'date';
            sortDirection = 'desc';
            updateShinedustMap(); // Update shinedust map from all data
            document.getElementById('packFilterContainer').dataset.initialized = '';
            document.getElementById('cardFilterContainer').dataset.initialized = '';
            enableControls();
            updateStats();
            populateFilters();
            renderTable();
        }

        function updateShinedustMap() {
            // Clear existing map
            accountShinedustMap.clear();

            // Group data by deviceAccount
            const accountGroups = new Map();
            allData.forEach(row => {
                if (!accountGroups.has(row.deviceAccount)) {
                    accountGroups.set(row.deviceAccount, []);
                }
                accountGroups.get(row.deviceAccount).push(row);
            });

            // For each account, find the latest shinedust value
            accountGroups.forEach((rows, deviceAccount) => {
                // Sort by timestamp to get the latest entry
                const sortedRows = rows.sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return dateB - dateA; // Descending order (latest first)
                });

                // Find the first entry with a shinedust value
                const latestShinedustEntry = sortedRows.find(row => row.shinedust && row.shinedust.trim() !== '');

                if (latestShinedustEntry) {
                    accountShinedustMap.set(deviceAccount, latestShinedustEntry.shinedust);
                }
            });
        }

        function enableControls() {
            document.getElementById('searchInput').disabled = false;
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('expandToggleBtn').disabled = false;
            // Hide load CSV button
            document.getElementById('loadCSVBtn').style.display = 'none';
        }

        function updateStats() {
            const uniqueAccounts = new Set(allData.map(row => row.deviceAccount)).size;
            const totalCards = allData.reduce((sum, row) =>
                sum + row.cardCounts.reduce((a, b) => a + b, 0), 0
            );

            document.getElementById('uniqueAccounts').textContent = uniqueAccounts;
            document.getElementById('totalCards').textContent = totalCards;
        }

        function populateFilters() {
            populatePackFilter();
            updateCardFilter();
            setupFilterListeners();
        }

        function populatePackFilter() {
            const packTypes = new Set(allData.map(row => row.packType).filter(pack => pack && pack.trim() !== ''));
            const container = document.getElementById('packFilterContainer');
            const previousSelection = new Set(getCheckedValues('packFilterContainer'));
            const firstRender = !container.dataset.initialized;
            const existingPackInputs = Array.from(container.querySelectorAll('input[type="checkbox"]'));
            const hadAllChecked = existingPackInputs.length === 0 || existingPackInputs.every(cb => cb.checked);

            container.innerHTML = '';

            packTypes.forEach(pack => {
                const label = document.createElement('label');
                label.className = 'checkbox-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = pack;
                checkbox.id = makeSafeId('pack', pack);
                checkbox.checked = firstRender || previousSelection.has(pack) || hadAllChecked;

                const text = document.createElement('span');
                text.textContent = translatePackType(pack);

                label.appendChild(checkbox);
                label.appendChild(text);
                container.appendChild(label);
            });

            container.dataset.initialized = 'true';

            addSelectAllButtons('packFilterContainer');
        }

        function setupFilterListeners() {
            const packContainer = document.getElementById('packFilterContainer');
            const cardContainer = document.getElementById('cardFilterContainer');
            const searchInput = document.getElementById('searchInput');

            if (packContainer) {
                packContainer.onchange = () => {
                    updateCardFilter();
                    applyFilters();
                };
            }

            if (cardContainer) {
                cardContainer.onchange = applyFilters;
            }

            const newSearchInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);

            // Add fresh listeners
            document.getElementById('searchInput').addEventListener('input', applyFilters);
        }

        function updateCardFilter() {
            const cardContainer = document.getElementById('cardFilterContainer');
            const selectedPacks = getCheckedValues('packFilterContainer');
            const previousSelection = new Set(getCheckedValues('cardFilterContainer'));
            const firstRender = !cardContainer.dataset.initialized;
            const existingCardInputs = Array.from(cardContainer.querySelectorAll('input[type="checkbox"]'));
            const hadAllChecked = existingCardInputs.length === 0 || existingCardInputs.every(cb => cb.checked);

            // Filter data based on current pack selections
            const dataToCount = selectedPacks.length > 0
                ? allData.filter(row => selectedPacks.includes(row.packType))
                : allData;

            // Calculate card counts from filtered data
            const cardTypes = new Map();
            dataToCount.forEach(row => {
                row.cardTypes.forEach((type, idx) => {
                    const count = row.cardCounts[idx] || 0;
                    cardTypes.set(type, (cardTypes.get(type) || 0) + count);
                });
            });

            // Rebuild the card filter checkboxes
            cardContainer.innerHTML = '';

            cardTypes.forEach((count, card) => {
                const label = document.createElement('label');
                label.className = 'checkbox-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = card;
                checkbox.id = makeSafeId('card', card);
                checkbox.checked = firstRender || previousSelection.has(card) || hadAllChecked;

                const text = document.createElement('span');
                text.innerHTML = `${getCardDisplayName(card)} (${count})`;

                label.appendChild(checkbox);
                label.appendChild(text);
                cardContainer.appendChild(label);
            });

            cardContainer.dataset.initialized = 'true';

            addSelectAllButtons('cardFilterContainer');
        }

        function sortData(column) {
            if (sortColumn === column) {
                // Toggle direction if clicking same column
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, default to descending
                sortColumn = column;
                sortDirection = 'desc';
            }

            renderTable();
        }

        function applyFilters() {
            const selectedPacks = getCheckedValues('packFilterContainer');
            const selectedCards = getCheckedValues('cardFilterContainer');
            const searchText = document.getElementById('searchInput').value.toLowerCase();

            if (selectedPacks.length === 0 || selectedCards.length === 0) {
                filteredData = [];
                expandedAccounts.clear();
                allExpanded = false;
                renderTable();
                return;
            }

            filteredData = allData.filter(row => {
                if (!selectedPacks.includes(row.packType)) return false;
                if (!row.cardTypes.some(type => selectedCards.includes(type))) return false;
                if (searchText) {
                    const searchableText = (row.cleanFilename + row.deviceAccount + row.originalFilename).toLowerCase();
                    if (!searchableText.includes(searchText)) return false;
                }
                return true;
            });

            expandedAccounts.clear();
            allExpanded = false;
            renderTable();
        }

        function getCardDisplayName(cardType) {
            const type = cardType.toLowerCase();
            const translated = translateCardType(cardType);

            if (type === 'crown') return '<span class="card-star">üëë</span> <span class="card-crown">' + translated + '</span>';
            if (type === 'fullart') return '<span class="card-star">‚òÖ‚òÖ</span> <span class="card-fullart">' + translated + '</span>';
            if (type === 'trainer') return '<span class="card-star">‚òÖ‚òÖ</span> <span class="card-trainer">' + translated + '</span>';
            if (type === 'rainbow') return '<span class="card-star">‚òÖ‚òÖ</span> <span class="card-rainbow">' + translated + '</span>';
            if (type === 'shiny1star') return '<span class="card-star">‚òÖ</span> <span class="card-shiny">' + translated + '</span>';
            if (type === 'shiny2star') return '<span class="card-star">‚òÖ‚òÖ</span> <span class="card-shiny">' + translated + '</span>';
            if (type === '1star') return '<span class="card-star">‚òÖ</span> ' + translated;
            if (type === '2star') return '<span class="card-star">‚òÖ‚òÖ</span> ' + translated;
            if (type === 'immersive') return '<span class="card-immersive">' + translated + '</span>';
            if (type === '4diamond') return '<span class="card-diamond">‚óÜ‚óÜ‚óÜ‚óÜ</span>';
            if (type === '3diamond') return '<span class="card-diamond">‚óÜ‚óÜ‚óÜ</span>';
            if (type === '2diamond') return '<span class="card-diamond">‚óÜ‚óÜ</span>';
            if (type === '1diamond') return '<span class="card-diamond">‚óÜ</span>';
            return translated;
        }

        function aggregateByAccount(data) {
            const accountMap = new Map();

            data.forEach(row => {
                const key = row.deviceAccount;
                if (!accountMap.has(key)) {
                    accountMap.set(key, {
                        deviceAccount: row.deviceAccount,
                        firstSeen: row.timestamp,
                        lastSeen: row.timestamp,
                        totalPulls: 0,
                        packTypes: new Set(),
                        cards: new Map(),
                        details: []
                    });
                }

                const account = accountMap.get(key);
                account.totalPulls++;
                account.packTypes.add(row.packType);
                account.lastSeen = row.timestamp;
                account.details.push(row);

                row.cardTypes.forEach((cardType, idx) => {
                    const count = row.cardCounts[idx];
                    if (account.cards.has(cardType)) {
                        account.cards.set(cardType, account.cards.get(cardType) + count);
                    } else {
                        account.cards.set(cardType, count);
                    }
                });
            });

            return Array.from(accountMap.values());
        }

        function toggleAccount(deviceAccount) {
            allExpanded = false;
            if (expandedAccounts.has(deviceAccount)) {
                expandedAccounts.delete(deviceAccount);
            } else {
                expandedAccounts.add(deviceAccount);
            }
            renderTable();
        }

        function calculateAgeDays(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function renderTable() {
            const t = translations[currentLanguage];
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');

            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <h2>${csvLoaded ? t.noResults : t.noData}</h2>
                            <p>${csvLoaded ? t.tryFilters : t.clickLoad}</p>
                        </td>
                    </tr>
                `;
                updateExpandButtonText();
                return;
            }

            const dateClass = sortColumn === 'date' ? `sorted-${sortDirection}` : '';
            const shinedustClass = sortColumn === 'shinedust' ? `sorted-${sortDirection}` : '';

            thead.innerHTML = `
                <tr>
                    <th class="col-account"><span data-i18n="deviceAccount">${t.deviceAccount}</span></th>
                    <th class="col-pack"><span data-i18n="pack">${t.pack}</span></th>
                    <th class="col-cards"><span data-i18n="cards">${t.cards}</span></th>
                    <th class="col-shinedust sortable ${shinedustClass}" onclick="sortData('shinedust')"><span data-i18n="shinedust">${t.shinedust}</span></th>
                    <th class="col-screenshot"><span data-i18n="screenshot">${t.screenshot}</span></th>
                    <th class="col-xml"><span data-i18n="xml">${t.xml}</span></th>
                    <th class="col-subTime sortable ${dateClass}" onclick="sortData('date')"><span data-i18n="date">${t.date}</span></th>
                    <th class="col-age"><span data-i18n="ageDays">${t.ageDays}</span></th>
                </tr>
            `;

            let aggregated = aggregateByAccount(filteredData);

            // Apply sorting
            if (sortColumn === 'date') {
                aggregated.sort((a, b) => {
                    const dateA = new Date(a.lastSeen);
                    const dateB = new Date(b.lastSeen);
                    return sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
                });
            } else if (sortColumn === 'shinedust') {
                aggregated.sort((a, b) => {
                    const shinedustA = accountShinedustMap.has(a.deviceAccount)
                        ? parseInt(accountShinedustMap.get(a.deviceAccount), 10) || 0
                        : 0;
                    const shinedustB = accountShinedustMap.has(b.deviceAccount)
                        ? parseInt(accountShinedustMap.get(b.deviceAccount), 10) || 0
                        : 0;
                    return sortDirection === 'asc' ? shinedustA - shinedustB : shinedustB - shinedustA;
                });
            }

            tbody.innerHTML = '';

            aggregated.forEach(account => {
                const tr = document.createElement('tr');
                const isExpanded = expandedAccounts.has(account.deviceAccount);
                tr.className = isExpanded ? 'expandable expanded' : 'expandable';

                const expandIcon = isExpanded ? '‚ñº' : '‚ñ∂';

                const cardsHTML = Array.from(account.cards.entries())
                    .map(([type, count]) => {
                        const typeLower = type.toLowerCase();
                        return `<span class="summary-badge"><span class="badge badge-card badge-${typeLower}">${getCardDisplayName(type)} √ó${count}</span></span>`;
                    })
                    .join(' ');

                const packsHTML = Array.from(account.packTypes)
                    .filter(pack => pack && pack.length > 0)
                    .map(pack => `<span class="badge badge-pack">${translatePackType(pack)}</span>`)
                    .join(' ');

                const xmlFilenames = [...new Set(account.details.map(d => d.cleanFilename))].join(', ');
                const originalFileName = account.details.map(d => d.originalFilename).join(',');

                // Get latest shinedust value from the stored map (not affected by filtering)
                const latestShinedust = accountShinedustMap.get(account.deviceAccount) || '';

                const shinedust = latestShinedust !== '' ? parseInt(latestShinedust) : 0;
                const shinedustClass = shinedust >= 25000 ? 'shinedust-high' : (shinedust > 0 ? 'shinedust-low' : '');
                const shinedustHTML = latestShinedust !== '' ? `<span class="${shinedustClass}">${latestShinedust}</span>` : '';

                const ageDays = calculateAgeDays(account.firstSeen);

                tr.innerHTML = `
                    <td class="device-account">
                        <span class="expand-icon ${isExpanded ? 'expanded' : ''}">${expandIcon}</span>
                        ${shortenDeviceAccount(account.deviceAccount)}
                    </td>
                    <td>${packsHTML}</td>
                    <td class="col-cards"><div class="summary-stats">${cardsHTML}</div></td>
                    <td class="col-shinedust">${shinedustHTML}</td>
                    <td class="col-screenshot"></td>
                    <td class="col-xml">${xmlFilenames}&nbsp;&nbsp;&nbsp;<span class="xmlDownloadLink" data-info="${originalFileName}" data-account="${
                        account.deviceAccount
                    }"><i class="fas fa-download"></i></span></td>
                    <td class="time-cell">${account.lastSeen.split(' ')[0]}</td>
                    <td class="col-age">${ageDays}</td>
                `;

                tr.onclick = () => toggleAccount(account.deviceAccount);
                tbody.appendChild(tr);

                if (isExpanded) {
                    let detailRowHtml = '';
                    let screenshotTag = '';
                    const validDetails = account.details.filter(detail =>
                        !(detail.packType.length == 0 && detail.shinedust > 0)
                    );

                    validDetails.forEach((detail, index) => {
                        const detailTr = document.createElement('tr');
                        const isLastDetail = index === validDetails.length - 1;
                        detailTr.className = isLastDetail ? 'detail-row last-detail-row' : 'detail-row';

                        const detailCardsHTML = detail.cardTypes.map((type, idx) => {
                            const typeLower = type.toLowerCase();
                            return `<span class="badge badge-card badge-${typeLower}">${getCardDisplayName(type)} √ó${detail.cardCounts[idx]}</span>`;
                        }).join(' ');

                        const screenshotFileName = detail.packScreenshot.replace(/\n/g, "");

                        detailRowHtml = `
                            <td class="device-account"></td>
                            <td><span class="badge badge-pack">${translatePackType(detail.packType)}</span></td>
                            <td class="col-cards">${detailCardsHTML}</td>
                            <td class="col-shinedust"></td>
                            <td class="detail-screenshot">
                        `;
                        screenshotTag = ``;
                        if(screenshotFileName.trim().length > 0){
                            screenshotTag = `<img class="PackScreenshot" src="../../Screenshots/Trades/${screenshotFileName}">`;
                        }
                        detailRowHtml += screenshotTag;
                        detailRowHtml += `
                            </td>
                            <td class="col-xml" title="${detail.originalFilename}">${detail.cleanFilename}</td>
                            <td class="time-cell">${detail.timestamp}</td>
                            <td class="col-age"></td>
                        `;
                        detailTr.innerHTML = detailRowHtml;

                        tbody.appendChild(detailTr);
                    });
                }
            });

            document.querySelectorAll('.PackScreenshot').forEach(el => {
                el.addEventListener('click', openPopup);
            });

            document.querySelectorAll('.xmlDownloadLink').forEach(el => {
                el.addEventListener('click', function(event) {
                    event.stopPropagation();
                    if (!filesUploaded) {
                        alert('Navigate to the /Accounts/Saved/ folder, then click "Upload".');
                        document.getElementById('xmlFileInput').click();
                    } else {
                        // Download the specific XML file for this row
                        const deviceAccount = this.getAttribute("data-account");
                        const info = this.getAttribute('data-info');
                        const filenames = info.split(',');
                        let matchingFile = null;
                        if (
                            deviceAccount &&
                            uploadedFiles.has(deviceAccount)
                        ) {
                            matchingFile = uploadedFiles.get(deviceAccount);
                        } else {
                            matchingFile = Array.from(
                                uploadedFiles.values()
                            ).find((file) =>
                                filenames.some(
                                    (fn) => fn.trim() === file.name
                                )
                            );
                        }
                        if (matchingFile) {
                            const url = URL.createObjectURL(matchingFile);
                            const a = document.createElement("a");
                            a.href = url;
                            a.download = matchingFile.name;
                            a.click();
                            URL.revokeObjectURL(url);
                        } else {
                            alert(
                                "Matching XML file not found in uploaded files."
                            );
                        }
                    }
                });
            });

            updateExpandButtonText();
        }

        function openPopup(event) {
            event.stopPropagation();
            const imgObj = event.currentTarget;
            const popupImg = document.getElementById('popup-img');

            popupImg.src = imgObj.src;
            popup.style.display = 'flex';
        }

        function exportFiltered() {
            const t = translations[currentLanguage];
            if (filteredData.length === 0) {
                alert(t.noResults);
                return;
            }

            const headers = 'Timestamp,OriginalFilename,CleanFilename,DeviceAccount,PackType,CardTypes,CardCounts,PackScreenshot,Shinedust\n';
            const rows = filteredData.map(row =>
                `${row.timestamp},${row.originalFilename},${row.cleanFilename},${row.deviceAccount},${row.packType},${row.cardTypes.join('|')},${row.cardCounts.join('|')},${row.packScreenshot},${row.shinedust || ''}`
            ).join('\n');

            const csv = headers + rows;
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trades_export_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</head>
<body>
    <div class="popup-overlay" id="popup">
        <div class="popup-content">
            <img id="popup-img" src="" alt="Enlarged Image">
            <br>
            <button class="close-btn" id="closeBtn">Close</button>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1>save4trade database</h1>
            <p>for ptcgp bot (kevinnnn)</p>
            <div class="kofi-container">
                <a href="https://ko-fi.com/kevnitg" target="_blank" rel="noopener noreferrer">
                    <img src="../../GUI/images/support_me_on_kofi.png" alt="support me on ko-fi" />
                </a>
                <div class="language-selector">
                    <select id="languageSelect" onchange="changeLanguage()">
                        <option value="en">English</option>
                        <option value="zh">‰∏≠Êñá</option>
                        <option value="ja">Êó•Êú¨Ë™û</option>
                        <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                        <option value="de">Deutsch</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="es">Espa√±ol</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="number" id="uniqueAccounts">0</div>
                <div class="label"><i class="fas fa-users"></i> unique accounts</div>
            </div>
            <div class="stat-card">
                <div class="number" id="totalCards">0</div>
                <div class="label"><i class="fas fa-layer-group"></i> total cards</div>
            </div>
        </div>

        <div class="controls">
            <div class="filter-group">
                <button class="btn" id="loadCSVBtn" onclick="document.getElementById('fileInput').click()"><i class="fas fa-upload"></i> load csv</button>
                <input type="file" id="fileInput" accept=".csv">
                <input type="file" id="xmlFileInput" webkitdirectory multiple style="display:none">

                <input type="text" id="searchInput" placeholder="search account..." disabled>

                <div class="filter-stack">
                    <span class="filter-label" data-i18n="allPacks">all packs</span>
                    <div id="packFilterContainer" class="checkbox-group"></div>
                </div>

                <div class="filter-stack">
                    <span class="filter-label" data-i18n="allCards">all cards</span>
                    <div id="cardFilterContainer" class="checkbox-group"></div>
                </div>

                <button class="btn" id="expandToggleBtn" onclick="toggleExpandAll()" disabled><i class="fas fa-expand"></i> expand all</button>

                <button class="btn export-btn" onclick="exportFiltered()" id="exportBtn" disabled><i class="fas fa-download"></i> export</button>
            </div>
        </div>

        <div class="table-container">
            <table id="mainTable">
                <thead id="tableHead">
                    <tr>
                        <th class="col-account"><span data-i18n="deviceAccount">deviceAccount</span></th>
                        <th class="col-pack"><span data-i18n="pack">pack</span></th>
                        <th class="col-cards"><span data-i18n="cards">cards</span></th>
                        <th class="col-shinedust"><span data-i18n="shinedust">shinedust</span></th>
                        <th class="col-screenshot"><span data-i18n="screenshot">screenshot</span></th>
                        <th class="col-xml"><span data-i18n="xml">.xml</span></th>
                        <th class="col-subTime"><span data-i18n="date">date</span></th>
                        <th class="col-age"><span data-i18n="ageDays">age (days)</span></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="8" class="empty-state">
                            <h2>no data loaded</h2>
                            <p>click load csv to view database</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>
