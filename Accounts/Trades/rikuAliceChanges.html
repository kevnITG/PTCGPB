<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Save4Trade Database</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="popup-overlay" id="popup">
        <div class="popup-content">
            <img id="popup-img" src="" alt="Expanded Image">
            <button class="close-btn" id="closeBtn"><i class="fas fa-times"></i> Close</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1><i class="fas fa-database"></i> Save4Trade Database</h1>
                    <p>For PTCGP Bot (kevinnnn)</p>
                </div>
                <div class="kofi-container">
                    <a href="https://ko-fi.com/kevnitg" target="_blank" rel="noopener noreferrer">
                        <img src="../../GUI/images/support_me_on_kofi.png" alt="Support me on Ko-fi" />
                    </a>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="number" id="uniqueAccounts">0</div>
                <div class="label"><i class="fas fa-users"></i> Unique Accounts</div>
            </div>
            <div class="stat-card">
                <div class="number" id="accountsWithout">0</div>
                <div class="label"><i class="fas fa-user-slash"></i> w/o Shinedust</div>
            </div>
            <div class="stat-card">
                <div class="number" id="accountsWith">0</div>
                <div class="label"><i class="fas fa-user-check"></i> w/ Shinedust</div>
            </div>
            <div class="stat-card">
                <div class="number" id="maxShinedust">0</div>
                <div class="label"><i class="fas fa-star"></i> Max Shinedust</div>
            </div>
            <div class="stat-card">
                <div class="number" id="totalCards">0</div>
                <div class="label"><i class="fas fa-cards"></i> Total Cards</div>
            </div>
        </div>

        <div class="controls">
            <div class="filter-group">
                <button class="btn load-csv-btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload"></i> Load CSV
                </button>
                <input type="file" id="fileInput" accept=".csv">

                <div class="view-mode-toggle disabled" id="viewModeToggle">
                    <button class="btn active" onclick="setViewMode('aggregated')" disabled>
                        <i class="fas fa-chart-bar"></i> Accounts
                    </button>
                    <button class="btn" onclick="setViewMode('detailed')" disabled>
                        <i class="fas fa-list"></i> Raw Data
                    </button>
                </div>

                <label for="packFilter">
                    <i class="fas fa-box"></i> Pack
                </label>
                <select id="packFilter" disabled>
                    <option value="">All Packs</option>
                </select>

                <label for="cardFilter">
                    <i class="fas fa-gem"></i> Card
                </label>
                <select id="cardFilter" disabled>
                    <option value="">All Cards</option>
                </select>

                <label for="searchInput">
                    <i class="fas fa-search"></i> Search
                </label>
                <input type="text" id="searchInput" placeholder="Search accounts..." disabled>
            </div>

            <div class="advanced-filters" id="advancedFilters" style="display: none;">
                <label for="dateFrom">
                    <i class="fas fa-calendar-alt"></i>
                </label>
                <input type="date" id="dateFrom" disabled>

                <label for="dateTo">
                    <i class="fas fa-calendar-alt"></i>
                </label>
                <input type="date" id="dateTo" disabled>

                <label for="minShinedust">
                    <i class="fas fa-star"></i> Shinedust
                </label>
                <input type="number" id="minShinedust" min="0" placeholder="0" disabled>

                <button class="btn" onclick="toggleAdvancedFilters()" id="toggleAdvancedBtn">
                    <i class="fas fa-filter"></i>
                </button>
                <button class="btn clear-filters-btn" onclick="clearFilters()" id="clearFiltersBtn" disabled>
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <button class="btn export-btn" onclick="exportFiltered()" id="exportBtn" disabled>
                <i class="fas fa-download"></i> Export
            </button>

            <input type="file" id="savedDirPicker" webkitdirectory multiple style="display: none;">
        </div>

        <div class="table-container">
            <table id="mainTable">
                <thead id="tableHead">
                    <tr>
                        <th class="sortable" data-sort="deviceAccount">Device Account</th>
                        <th class="sortable" data-sort="pack">Pack</th>
                        <th class="sortable" data-sort="cards">Cards</th>
                        <th class="sortable" data-sort="xml">.xml Filename</th>
                        <th class="sortable" data-sort="time">Time</th>
                        <th class="sortable" data-sort="shinedust">Shinedust</th>
                        <th>Screenshot</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="7" class="empty-state">
                            <h2><i class="fas fa-info-circle"></i> No Data Loaded</h2>
                            <p>Click "Load CSV" to view your database</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let filesList = [];
        let allData = [];
        let filteredData = [];
        let viewMode = 'aggregated';
        let expandedAccounts = new Set();
        let isLoading = false;
        let currentCSVFile = null;
        let currentSort = { column: null, direction: 'asc' };
        let advancedFiltersVisible = false;

        function toggleAdvancedFilters() {
            advancedFiltersVisible = !advancedFiltersVisible;
            const advancedFilters = document.getElementById('advancedFilters');
            const toggleBtn = document.getElementById('toggleAdvancedBtn');
            advancedFilters.style.display = advancedFiltersVisible ? 'flex' : 'none';
            toggleBtn.innerHTML = advancedFiltersVisible ? '<i class="fas fa-minus"></i> ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á' : '<i class="fas fa-plus"></i> ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á';
            if (advancedFiltersVisible) {
                document.getElementById('dateFrom').addEventListener('change', applyFilters);
                document.getElementById('dateTo').addEventListener('change', applyFilters);
                document.getElementById('minShinedust').addEventListener('input', debounce(applyFilters, 300));
                document.getElementById('clearFiltersBtn').disabled = false;
            } else {
                clearFilters();
            }
        }

        function clearFilters() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('minShinedust').value = '';
            applyFilters();
        }

        function showLoadSavedFolderPopup() {
            alert('Navigate to your /Accounts/Saved/ folder, then click "Upload".');
            document.getElementById('savedDirPicker').click();
        }

        function openPopup(event) {
            const imgObj = event.currentTarget;
            const popupImg = document.getElementById('popup-img');
            const popup = document.getElementById('popup');

            popupImg.src = imgObj.src;
            popup.style.display = 'flex';
        }

        function extractFixedPart(filename) {
            const match = filename.match(/P_(.*?)\(/);
            return match ? match[1] : null;
        }

        function downloadXMLFile(event) {
            const targetObj = event.currentTarget;
            const keyword = targetObj.dataset.info;
            const fixedPartKeyword = extractFixedPart(keyword);

            if (filesList.length === 0) {
                event.preventDefault();
                showLoadSavedFolderPopup();
                event.stopPropagation();
                return;
            }

            const matches = filesList.filter(f => f.name.includes(fixedPartKeyword));

            matches.forEach(f => {
                const url = URL.createObjectURL(f);
                const a = document.createElement('a');
                a.href = url;
                a.download = f.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            event.stopPropagation();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const popup = document.getElementById('popup');
            const closeBtn = document.getElementById('closeBtn');
            const dirPicker = document.getElementById('savedDirPicker');

            closeBtn.addEventListener('click', () => {
                popup.style.display = 'none';
            });

            popup.addEventListener('click', e => {
                if (e.target === popup) popup.style.display = 'none';
            });

            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') popup.style.display = 'none';
            });

            dirPicker.addEventListener('change', (e) => {
                filesList = Array.from(e.target.files);
                alert('All files in the Saved folder have been uploaded. Please try downloading the XML file again.');
            });

            // Drag and drop for CSV
            const fileInput = document.getElementById('fileInput');
            const dropZone = document.querySelector('.controls');
            dropZone.addEventListener('dragover', e => {
                e.preventDefault();
                dropZone.style.background = 'rgba(99, 102, 241, 0.05)';
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.background = '';
            });
            dropZone.addEventListener('drop', e => {
                e.preventDefault();
                dropZone.style.background = '';
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.csv')) {
                    fileInput.files = files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });

            // Sorting
            document.addEventListener('click', (e) => {
                if (e.target.closest('th.sortable')) {
                    const th = e.target.closest('th.sortable');
                    sortTable(th.dataset.sort);
                }
            });
        });

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            event.target.closest('th').classList.add(`sort-${currentSort.direction}`);

            applyFilters(); // Re-apply filters and sort
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            currentCSVFile = file;

            isLoading = true;
            const loadBtn = document.querySelector('.load-csv-btn');
            const originalText = loadBtn.innerHTML;
            loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            loadBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    parseCSV(event.target.result);
                } catch (error) {
                    console.error('Error parsing CSV:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                }
                loadBtn.innerHTML = originalText;
                loadBtn.disabled = false;
                isLoading = false;
            };
            reader.onerror = () => {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                loadBtn.innerHTML = originalText;
                loadBtn.disabled = false;
                isLoading = false;
            };
            reader.readAsText(file);
        });

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            allData = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                // Handle quoted fields better
                const values = parseCSVLine(lines[i]);
                if (values.length < 9) continue; // Skip invalid rows

                const row = {
                    timestamp: values[0] || '',
                    originalFilename: values[1] || '',
                    cleanFilename: values[2] || '',
                    deviceAccount: values[3] || '',
                    packType: values[4] || '',
                    cardTypes: values[5] ? values[5].split('|').filter(Boolean) : [],
                    cardCounts: values[6] ? values[6].split('|').map(n => parseInt(n) || 0) : [],
                    packScreenshot: values[7] ? values[7].trim().replace(/"/g, '') : '',
                    shinedust: values[8] ? values[8].trim().replace(/"/g, '') : '',
                };
                allData.push(row);
            }

            if (allData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå');
                return;
            }

            filteredData = [...allData];
            enableControls();
            updateStats();
            populateFilters();
            renderTable();
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim());
            return values;
        }

        function enableControls() {
            document.getElementById('viewModeToggle').classList.remove('disabled');
            document.querySelectorAll('#viewModeToggle .btn').forEach(btn => btn.disabled = false);
            document.getElementById('packFilter').disabled = false;
            document.getElementById('cardFilter').disabled = false;
            document.getElementById('searchInput').disabled = false;
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('savedDirPicker').disabled = false;
            document.getElementById('dateFrom').disabled = false;
            document.getElementById('dateTo').disabled = false;
            document.getElementById('minShinedust').disabled = false;
            document.getElementById('clearFiltersBtn').disabled = false;
        }

        function updateStats() {
            const aggregated = aggregateByAccount(allData);
            const uniqueAccounts = aggregated.length;
            const accountsWithout = aggregated.filter(a => a.totalShinedust === 0).length;
            const accountsWith = uniqueAccounts - accountsWithout;
            const maxShinedust = Math.max(...aggregated.map(a => a.totalShinedust), 0);
            const totalCards = allData.reduce((sum, row) =>
                sum + row.cardCounts.reduce((a, b) => a + b, 0), 0
            );

            document.getElementById('uniqueAccounts').textContent = uniqueAccounts.toLocaleString();
            document.getElementById('accountsWithout').textContent = accountsWithout.toLocaleString();
            document.getElementById('accountsWith').textContent = accountsWith.toLocaleString();
            document.getElementById('maxShinedust').textContent = maxShinedust.toLocaleString();
            document.getElementById('totalCards').textContent = totalCards.toLocaleString();
        }

        function populateFilters() {
            const packTypes = new Set(allData.map(row => row.packType).filter(Boolean));
            const cardTypes = new Set();
            allData.forEach(row => row.cardTypes.forEach(type => cardTypes.add(type)));

            const packFilter = document.getElementById('packFilter');
            packFilter.innerHTML = '<option value="">All Packs</option>';
            Array.from(packTypes).sort().forEach(pack => {
                packFilter.innerHTML += `<option value="${pack}">${pack}</option>`;
            });

            const cardFilter = document.getElementById('cardFilter');
            cardFilter.innerHTML = '<option value="">All Cards</option>';
            Array.from(cardTypes).sort().forEach(card => {
                cardFilter.innerHTML += `<option value="${card}">${getCardDisplayName(card)}</option>`;
            });

            packFilter.addEventListener('change', debounce(applyFilters, 200));
            cardFilter.addEventListener('change', debounce(applyFilters, 200));
            document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function setViewMode(mode) {
            viewMode = mode;
            expandedAccounts.clear();

            document.querySelectorAll('.view-mode-toggle .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            renderTable();
        }

        function applyFilters() {
            const packFilter = document.getElementById('packFilter').value;
            const cardFilter = document.getElementById('cardFilter').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const minShinedust = parseInt(document.getElementById('minShinedust').value) || 0;

            let data = allData.filter(row => {
                if (packFilter && row.packType !== packFilter) return false;
                if (cardFilter && !row.cardTypes.includes(cardFilter)) return false;
                if (searchText) {
                    const searchableText = (row.cleanFilename + row.deviceAccount + row.originalFilename).toLowerCase();
                    if (!searchableText.includes(searchText)) return false;
                }
                const rowDate = row.timestamp.split(' ')[0];
                if (dateFrom && rowDate < dateFrom) return false;
                if (dateTo && rowDate > dateTo) return false;
                if (parseInt(row.shinedust) < minShinedust) return false;
                return true;
            });

            // Apply sorting
            if (currentSort.column) {
                data.sort((a, b) => {
                    let valA = getSortValue(a, currentSort.column);
                    let valB = getSortValue(b, currentSort.column);
                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();
                    if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            filteredData = data;
            expandedAccounts.clear();
            renderTable();
        }

        function getSortValue(row, column) {
            switch (column) {
                case 'deviceAccount': return row.deviceAccount;
                case 'pack': return row.packType;
                case 'cards': return row.cardTypes.length;
                case 'xml': return row.cleanFilename;
                case 'time': return new Date(row.timestamp);
                case 'shinedust': return parseInt(row.shinedust) || 0;
                case 'firstSeen': return new Date(row.firstSeen);
                case 'lastSeen': return new Date(row.lastSeen);
                case 'totalShinedust': return row.totalShinedust;
                default: return '';
            }
        }

        function getCardDisplayName(cardType) {
            const type = cardType.toLowerCase();
            if (type === 'crown') return 'üëë Crown';
            if (type === 'fullart') return '‚òÖ‚òÖ Full Art';
            if (type === 'trainer') return '‚òÖ‚òÖ Trainer';
            if (type === 'rainbow') return '‚òÖ‚òÖ Rainbow';
            if (type === 'shiny1star') return '‚òÖ Shiny';
            if (type === 'shiny2star') return '‚òÖ‚òÖ Shiny';
            if (type === 'immersive') return 'Immersive';
            return cardType;
        }

        function aggregateByAccount(data) {
            const accountMap = new Map();

            data.forEach(row => {
                const key = row.deviceAccount;
                if (!accountMap.has(key)) {
                    accountMap.set(key, {
                        deviceAccount: row.deviceAccount,
                        firstSeen: row.timestamp,
                        lastSeen: row.timestamp,
                        totalPulls: 0,
                        totalShinedust: 0,
                        packTypes: new Set(),
                        cards: new Map(),
                        details: []
                    });
                }

                const account = accountMap.get(key);
                account.totalPulls++;
                account.packTypes.add(row.packType);

                // Update firstSeen to the earliest timestamp
                if (!account.firstSeen || row.timestamp < account.firstSeen) {
                    account.firstSeen = row.timestamp;
                }
                // Update lastSeen to the latest timestamp
                if (!account.lastSeen || row.timestamp > account.lastSeen) {
                    account.lastSeen = row.timestamp;
                }

                // Sum shinedust from all details (merge old data)
                account.totalShinedust += parseInt(row.shinedust) || 0;

                account.details.push(row);

                row.cardTypes.forEach((cardType, idx) => {
                    const count = row.cardCounts[idx] || 0;
                    account.cards.set(cardType, (account.cards.get(cardType) || 0) + count);
                });
            });

            let aggregated = Array.from(accountMap.values());
            // Apply sorting to aggregated data if sort column is account-specific
            if (currentSort.column === 'deviceAccount' || currentSort.column === 'totalShinedust') {
                aggregated.sort((a, b) => {
                    let valA = currentSort.column === 'deviceAccount' ? a.deviceAccount : a.totalShinedust;
                    let valB = currentSort.column === 'deviceAccount' ? b.deviceAccount : b.totalShinedust;
                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();
                    if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            } else {
                aggregated.sort((a, b) => b.totalPulls - a.totalPulls);
            }

            return aggregated;
        }

        function toggleAccount(deviceAccount) {
            if (expandedAccounts.has(deviceAccount)) {
                expandedAccounts.delete(deviceAccount);
            } else {
                expandedAccounts.add(deviceAccount);
            }
            renderTable();
        }

        function renderTable() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');

            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <h2><i class="fas fa-search"></i> No Results</h2>
                            <p>Try adjusting your filters</p>
                        </td>
                    </tr>
                `;
                return;
            }

            let tableRows = '';

            if (viewMode === 'aggregated') {
                thead.innerHTML = `
                    <tr>
                        <th class="sortable" data-sort="deviceAccount">Device Account</th>
                        <th class="sortable" data-sort="pack">Packs</th>
                        <th>Cards Collected</th>
                        <th class="sortable" data-sort="xml">.xml Filename <button class="header-import-btn" onclick="showLoadSavedFolderPopup()" id="importXmlBtn">Load Saved Folder</button></th>
                        <th class="sortable" data-sort="firstSeen">First Seen</th>
                        <th class="sortable" data-sort="lastSeen">Last Seen</th>
                        <th class="sortable" data-sort="totalShinedust">Shinedust (Total)</th>
                        <th>Screenshot</th>
                    </tr>
                `;

                const aggregated = aggregateByAccount(filteredData);

                aggregated.forEach(account => {
                    const isExpanded = expandedAccounts.has(account.deviceAccount);
                    const expandIcon = isExpanded ? '<i class="fas fa-chevron-down"></i>' : '<i class="fas fa-chevron-right"></i>';

                    const cardsHTML = Array.from(account.cards.entries())
                        .map(([type, count]) => `<span class="badge badge-card">${getCardDisplayName(type)} √ó${count}</span>`)
                        .join('');

                    const packsHTML = Array.from(account.packTypes)
                        .filter(pack => pack && pack.length > 0)
                        .map(pack => `<span class="badge badge-pack">${pack}</span>`)
                        .join('');

                    const xmlFilenames = [...new Set(account.details.map(d => d.cleanFilename))].join(', ');
                    const originalFileName = account.details.map(d => d.originalFilename).join(',');

                    tableRows += `
                        <tr class="expandable" onclick="toggleAccount('${account.deviceAccount}')">
                            <td title="${account.deviceAccount}">
                                <span class="expand-icon ${isExpanded ? 'expanded' : ''}">${expandIcon}</span>
                                ${account.deviceAccount}
                            </td>
                            <td>${packsHTML}</td>
                            <td><div class="summary-stats">${cardsHTML}</div></td>
                            <td title="${xmlFilenames}">${xmlFilenames ? xmlFilenames : '<em>No XML</em>'}&nbsp;<a href="#" class="xmlDownloadLink" data-info="${originalFileName}"><i class="fas fa-download"></i></a></td>
                            <td class="time-cell">${account.firstSeen}</td>
                            <td class="time-cell">${account.lastSeen}</td>
                            <td class="${account.totalShinedust > 100 ? 'shinedust-high' : ''}"><strong>${account.totalShinedust}</strong></td>
                            <td></td>
                        </tr>
                    `;

                    if (isExpanded) {
                        account.details.forEach(detail => {
                            if (detail.packType.length === 0 && parseInt(detail.shinedust) > 0) return;

                            const detailCardsHTML = detail.cardTypes.map((type, idx) => {
                                const count = detail.cardCounts[idx] || 0;
                                if (count > 0) return `<span class="badge badge-card">${getCardDisplayName(type)} √ó${count}</span>`;
                                return '';
                            }).filter(Boolean).join('');

                            const screenshotFileName = detail.packScreenshot.replace(/\n/g, "").trim();
                            let screenshotTag = '<em>No Screenshot</em>';
                            if (screenshotFileName.length > 0) {
                                screenshotTag = `<img class="PackScreenshot" src="../../Screenshots/Trades/${screenshotFileName}" alt="Pack Screenshot">`;
                            }

                            tableRows += `
                                <tr class="detail-row">
                                    <td></td>
                                    <td><span class="badge badge-pack">${detail.packType || ''}</span></td>
                                    <td>${detailCardsHTML || '<em>No cards</em>'}</td>
                                    <td title="${detail.originalFilename}">${detail.cleanFilename ? detail.cleanFilename : ''}&nbsp;<a href="#" class="xmlDownloadLink" data-info="${detail.originalFilename}"><i class="fas fa-download"></i></a></td>
                                    <td></td>
                                    <td class="time-cell">${detail.timestamp}</td>
                                    <td>${detail.shinedust || ''}</td>
                                    <td class="detail-screenshot">${screenshotTag}</td>
                                </tr>
                            `;
                        });
                    }
                });
            } else {
                thead.innerHTML = `
                    <tr>
                        <th class="sortable" data-sort="pack">Pack</th>
                        <th>Cards Collected</th>
                        <th class="sortable" data-sort="xml">.xml Filename</th>
                        <th class="sortable" data-sort="deviceAccount">Device Account</th>
                        <th class="sortable" data-sort="time">Time</th>
                        <th class="sortable" data-sort="shinedust">Shinedust</th>
                        <th>Screenshot</th>
                    </tr>
                `;

                filteredData.forEach(row => {
                    const cardsHTML = row.cardTypes.map((type, idx) => {
                        const count = row.cardCounts[idx] || 0;
                        if (count > 0) return `<span class="badge badge-card">${getCardDisplayName(type)} √ó${count}</span>`;
                        return '';
                    }).filter(Boolean).join('');

                    const screenshotFileName = row.packScreenshot.trim();
                    let screenshotTag = '<em>No Screenshot</em>';
                    if (screenshotFileName.length > 0) {
                        screenshotTag = `<img class="PackScreenshot" src="../../Screenshots/Trades/${screenshotFileName}" alt="Pack Screenshot">`;
                    }

                    let packHTML = '<td></td>';
                    if (row.packType.length > 0) {
                        packHTML = `<td><span class="badge badge-pack">${row.packType}</span></td>`;
                    }

                    tableRows += `
                        <tr>
                            ${packHTML}
                            <td>${cardsHTML || '<em>No cards</em>'}</td>
                            <td title="${row.originalFilename}">${row.cleanFilename ? row.cleanFilename : ''}&nbsp;<a href="#" class="xmlDownloadLink" data-info="${row.originalFilename}"><i class="fas fa-download"></i></a></td>
                            <td class="device-account" title="${row.deviceAccount}">${row.deviceAccount}</td>
                            <td class="time-cell">${row.timestamp}</td>
                            <td class="${parseInt(row.shinedust) > 100 ? 'shinedust-high' : ''}">${row.shinedust || ''}</td>
                            <td class="detail-screenshot">${screenshotTag}</td>
                        </tr>
                    `;
                });
            }

            tbody.innerHTML = tableRows;

            // Event listeners
            document.querySelectorAll('.xmlDownloadLink').forEach(el => el.addEventListener('click', downloadXMLFile));
            document.querySelectorAll('.PackScreenshot').forEach(el => el.addEventListener('click', openPopup));
        }

        function exportFiltered() {
            if (filteredData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞ export');
                return;
            }

            const headers = 'Timestamp,OriginalFilename,CleanFilename,DeviceAccount,PackType,CardTypes,CardCounts,PackScreenshot,Shinedust\n';
            const rows = filteredData.map(row =>
                `"${row.timestamp}","${row.originalFilename}","${row.cleanFilename}","${row.deviceAccount}","${row.packType}","${row.cardTypes.join('|')}","${row.cardCounts.join('|')}", "${row.packScreenshot}","${row.shinedust || ''}"`
            ).join('\n');

            const csv = headers + rows;
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trades_export_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
